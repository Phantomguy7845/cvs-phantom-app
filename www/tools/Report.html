<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#10b981" />
  <title>PT Report Tool (Mint)</title>

  <style>
    :root{
      --bg:#f6fffb;
      --card:#ffffff;
      --line:#d7efe7;
      --text:#0f172a;
      --muted:#475569;
      --muted2:#64748b;
      --accent:#10b981;
      --soft:#eafff6;
      --soft2:#f0fffa;
      --danger:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 10px 28px rgba(2, 6, 23, .08);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", sans-serif;
      padding: 14px 14px calc(18px + env(safe-area-inset-bottom));
    }
    .wrap{ max-width: 980px; margin: 0 auto; display:grid; gap: 12px; }
    header{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap: 10px; padding: 6px 4px;
    }
    h1{ margin:0; font-size: 18px; font-weight: 950; letter-spacing:.2px; line-height:1.2; }
    .sub{ margin-top: 4px; color: var(--muted); font-size: 12px; line-height:1.35; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background: #fff;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 850;
      user-select:none;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow);
    }
    .label{ font-size: 12px; color: var(--muted); margin-bottom: 6px; font-weight: 900; }
    .muted{ color: var(--muted2); font-size: 12px; line-height:1.35; }
    .mini{ font-size: 12px; color: var(--muted2); margin-top: 6px; line-height:1.35; }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    @media (max-width: 820px){ .grid3{ grid-template-columns: 1fr; } }
    @media (max-width: 680px){ .grid2{ grid-template-columns: 1fr; } }

    .row{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }
    .row.between{ justify-content:space-between; }

    .field{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--line);
      background: #ffffff;
      color: var(--text);
      padding: 12px 12px;
      font-size: 15px;
      outline: none;
    }
    textarea.field{ min-height: 104px; resize: vertical; }
    .field:focus{
      border-color: rgba(16,185,129,.55);
      box-shadow: 0 0 0 4px rgba(16,185,129,.16);
    }

    .btn{
      border: 1px solid var(--line);
      background: #ffffff;
      color: var(--text);
      padding: 12px 12px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 950;
      cursor:pointer;
      min-height: 46px;
      box-shadow: 0 8px 18px rgba(2,6,23,.06);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(16,185,129,.95), rgba(16,185,129,.70));
      border-color: rgba(16,185,129,.55);
      color: #053b2a;
    }
    .btn.soft{
      background: var(--soft);
      border-color: rgba(16,185,129,.30);
      color: #064e3b;
    }
    .btn.danger{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.35);
      color:#7f1d1d;
    }
    .btn.warn{
      background: rgba(245,158,11,.10);
      border-color: rgba(245,158,11,.35);
      color:#7c2d12;
    }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; transform:none; }

    .switch{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: #ffffff;
      user-select:none;
      min-height: 46px;
    }
    .switch input{ width: 20px; height: 20px; accent-color: var(--accent); }
    .switch span{ font-size: 15px; font-weight: 900; color: var(--text); }

    .hr{ height:1px; background: var(--line); margin: 10px 0; }

    .stickyBar{
      position: sticky;
      bottom: 10px;
      z-index: 10;
      display:grid;
      gap:10px;
      padding: 10px;
      background: rgba(246,255,251,.88);
      backdrop-filter: blur(8px);
      border:1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
    }

    .previewBox{
      border:1px solid rgba(2,6,23,.10);
      background: #ffffff;
      border-radius: 14px;
      overflow:hidden;
    }
    .previewHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      background: rgba(16,185,129,.06);
      border-bottom: 1px solid rgba(2,6,23,.08);
      gap: 10px;
    }
    .previewTitle{
      font-weight: 950;
      font-size: 13px;
      color:#064e3b;
    }
    pre{
      margin:0;
      padding: 10px 12px;
      font-size: 13px;
      line-height: 1.35;
      color: #0f172a;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 320px;
      overflow:auto;
    }

    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 950;
      border:1px solid var(--line);
      background:#fff;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .badge.ok{ border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.08); color:#065f46; }
    .badge.wait{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); color:#7c2d12; }
    .badge.err{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); color:#7f1d1d; }

    .histTop{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .histList{ display:grid; gap:10px; margin-top:10px; }
    .histItem{
      border:1px solid rgba(2,6,23,.10);
      background:#fff;
      border-radius: 16px;
      padding: 10px;
      box-shadow: 0 8px 18px rgba(2,6,23,.05);
    }
    .histRow{
      display:flex; align-items:flex-start; justify-content:space-between; gap: 10px;
    }
    .histLeft{ display:flex; gap: 10px; align-items:flex-start; }
    .histMain{ display:grid; gap: 2px; }
    .histTitle{
      font-weight: 950;
      font-size: 14px;
      color: #0f172a;
      line-height:1.25;
    }
    .histMeta{ font-size: 12px; color: var(--muted2); line-height:1.25; }
    .histActions{ display:flex; gap: 8px; flex-wrap:wrap; justify-content:flex-end; }
    .histActions .btn{ min-height: 40px; padding: 9px 10px; font-size: 13px; }
    .check{
      width: 22px; height: 22px; margin-top: 2px;
      accent-color: var(--accent);
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(18px + env(safe-area-inset-bottom));
      background: rgba(15, 23, 42, .92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 850;
      box-shadow: 0 14px 40px rgba(2,6,23,.30);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 999;
      max-width: min(520px, calc(100vw - 24px));
      text-align: center;
      white-space: pre-wrap;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-6px);
    }

    /* Modal */
    .modalBack{
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,.60);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      z-index: 1000;
    }
    .modal{
      width: min(520px, 100%);
      background:#fff;
      border-radius: 18px;
      border:1px solid var(--line);
      box-shadow: 0 18px 55px rgba(2,6,23,.28);
      overflow:hidden;
    }
    .modalHeader{
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
      background: var(--soft2);
    }
    .modalTitle{
      font-weight: 950;
      font-size: 14px;
      color:#064e3b;
    }
    .modalBody{ padding: 12px; display:grid; gap: 10px; }
    .modalText{ font-size: 14px; color: var(--text); line-height:1.35; }
    .modalFoot{ padding: 12px; display:grid; gap: 10px; border-top: 1px solid var(--line); }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>PT Report Script Tool (Mint)</h1>
        <div class="sub">‡∏Å‡∏î‡∏Å‡∏£‡∏≠‡∏Å ‚Üí COPY ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î LINE ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‚Ä¢ ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‚Ä¢ ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ + ‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
      </div>
      <span class="pill">‚òÄÔ∏è ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏î‡∏î</span>
    </header>

    <div class="card">
      <div class="label">1) ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>

      <div class="grid2">
        <div>
          <div class="label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
          <input id="reportDate" class="field" type="date" />
          <div class="mini"> </div>
        </div>

        <div>
          <div class="label">‡πÅ‡∏≠‡∏Ñ‡πÄ‡∏Ñ‡∏≤‡∏ó‡πå</div>
          <select id="account" class="field">
            <option value="" selected>‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏≠‡∏Ñ‡πÄ‡∏Ñ‡∏≤‡∏ó‡πå ‚Äî</option>
            <option value="CJ MORE">CJ MORE</option>
            <option value="LAWSON">LAWSON</option>
            <option value="BIG C">BIG C</option>
            <option value="VILLA MARKET">VILLA MARKET</option>
            <option value="LOTUS'S">LOTUS'S</option>
            <option value="JIFFY">JIFFY</option>
            <option value="TOPS">TOPS</option>
          </select>

          <div class="mini">‡∏Å‡∏î COPY ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå LINE ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡πÅ‡∏≠‡∏Ñ‡πÄ‡∏Ñ‡∏≤‡∏ó‡πå‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</div>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <div class="label">‡πÄ‡∏•‡∏Ç‡∏™‡∏≤‡∏Ç‡∏≤</div>
          <input id="branchCode" class="field" placeholder="-" />
        </div>
        <div>
          <div class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤</div>
          <input id="branchName" class="field" placeholder="-" />
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <div class="label">‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏° POG</div>
          <select id="pog" class="field">
            <option value="‡∏ï‡∏£‡∏á" selected>‡∏ï‡∏£‡∏á</option>
            <option value="‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á">‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á</option>
          </select>
        </div>
        <div>
          <div class="label">‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å SKU ‡πÑ‡∏´‡∏°</div>
          <select id="sku" class="field">
            <option value="‡∏Ñ‡∏£‡∏ö">‡∏Ñ‡∏£‡∏ö</option>
            <option value="‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö" selected>‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö</option>
          </select>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <div class="label">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ OOS</div>
          <textarea id="oos" class="field" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ OOS "></textarea>
        </div>
        <div>
          <div class="label">‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</div>
          <textarea id="issue" class="field" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô "></textarea>
        </div>
      </div>

      <div style="margin-top:10px">
        <div class="label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
        <textarea id="note" class="field" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ "></textarea>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <label class="switch">
          <input id="autoOpenLine" type="checkbox" />
          <span>‡πÄ‡∏õ‡∏¥‡∏î LINE ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á COPY</span>
        </label>

        <div class="row between">
          <span class="badge wait" id="statusBadge">‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà COPY</span>
          <button class="btn warn" id="btnResetForm">‚ôªÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
        </div>
      </div>

      <div class="mini" id="statusText">‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡∏ñ‡πâ‡∏≤ ‚Äú‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‚Äù ‡πÑ‡∏°‡πà‡πÄ‡∏î‡πâ‡∏á ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤ Chrome ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï pop-up ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô https (‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ô‡∏ö‡∏ô‡πÄ‡∏ß‡πá‡∏ö)</div>
    </div>

    <div class="card" id="previewSection">
      <div class="label">2) ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ (‡∏à‡∏∞‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ)</div>
      <div class="previewBox">
        <div class="previewHeader">
          <div class="previewTitle">Output Preview</div>
          <button class="btn soft" id="btnCopyOnly" style="min-height:40px; padding:9px 10px; font-size:13px;">üìã COPY (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î LINE)</button>
        </div>
        <pre id="preview"></pre>
      </div>
      <div class="mini">‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞ COPY ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î LINE)</div>
    </div>

    <div class="card" id="historyCard">
      <div class="label">3) ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (30 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</div>

      <div class="histTop">
        <div class="row" style="gap:8px">
          <span class="badge ok" id="histCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
          <span class="muted" id="histHint">‡∏ï‡∏¥‡πä‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ ‚Äú‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‚Äù</span>
        </div>

        <div class="row" style="gap:8px">
          <button class="btn" id="btnToggleAll">‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</button>
          <button class="btn danger" id="btnClearAll">‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
      </div>

      <div class="histList" id="histList"></div>
      <div class="mini">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å ‚Äú‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‚Äù ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î ‚Ä¢ ‡πÅ‡∏ï‡πà‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á ‚Äú‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô ‚Üí ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‚Äù ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</div>
    </div>

    <div class="stickyBar" id="stickyBar">
      <div class="grid2">
        <button class="btn primary" id="btnCopy">‚úÖ COPY + ‡πÄ‡∏õ‡∏¥‡∏î LINE ‡∏Å‡∏•‡∏∏‡πà‡∏°</button>
        <button class="btn soft" id="btnSummary">üßæ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î (‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡πä‡∏Å) + ‡πÄ‡∏õ‡∏¥‡∏î LINE ‡∏™‡∏£‡∏∏‡∏õ</button>
      </div>
      <div class="muted">
        ‚Ä¢ ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà(‡∏û.‡∏®.2‡∏´‡∏•‡∏±‡∏Å) + GBKK4 + ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î<br>
        ‚Ä¢ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î: ‚Äú‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà dd/mm/yyyy‚Äù + ‚ÄúGBBK 4‚Äù + ‡∏•‡∏¥‡∏™‡∏ï‡πå 1..n
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Confirm Modal -->
  <div class="modalBack" id="modalBack" aria-hidden="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle" id="modalTitle">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
        <button class="btn danger" id="modalClose" style="min-height:40px; padding:9px 10px; font-size:13px;">‡∏õ‡∏¥‡∏î</button>
      </div>
      <div class="modalBody">
        <div class="modalText" id="modalText">-</div>
      </div>
      <div class="modalFoot">
        <div class="grid2">
          <button class="btn danger" id="modalYes">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
          <button class="btn" id="modalNo">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  /* =========================
     ‚úÖ Embed Mode
  ========================== */
  const EMBED = new URLSearchParams(location.search).get("embed") === "1";

  /* =========================
     Storage Keys
  ========================== */
  const STORE_FORM = "PT_REPORT_FORM_V1";
  const STORE_HISTORY = "PT_REPORT_HISTORY_V1";
  const STORE_UI = "PT_REPORT_UI_V1";

  /* =========================
     Constants / URLs
  ========================== */
  const TEAM_REPORT = "GBKK4";
  const TEAM_SUMMARY = "GBBK 4";

  const LINE_GROUPS = {
    groupA: "https://line.me/R/ti/g/_udUgHC5kF",
    groupB: "https://line.me/R/ti/g/bVz2_mXbq8",
    groupC: "https://line.me/R/ti/g/XrNLFTykZG",
    summary: "https://line.me/R/ti/g/UEDp_YJDwn"
  };

  function getLineUrlByAccount(account){
    const a = (account || "").trim().toUpperCase();
    if (["CJ MORE","LAWSON","BIG C","VILLA MARKET"].includes(a)) return LINE_GROUPS.groupA;
    if (["JIFFY","TOPS"].includes(a)) return LINE_GROUPS.groupB;
    if (["LOTUS'S"].includes(a)) return LINE_GROUPS.groupC;
    return LINE_GROUPS.groupA;
  }

  /* =========================
     Elements
  ========================== */
  const $ = (id) => document.getElementById(id);

  const reportDate = $("reportDate");
  const account = $("account");
  const branchCode = $("branchCode");
  const branchName = $("branchName");
  const pog = $("pog");
  const sku = $("sku");
  const oos = $("oos");
  const issue = $("issue");
  const note = $("note");
  const autoOpenLine = $("autoOpenLine");

  const statusBadge = $("statusBadge");
  const statusText = $("statusText");

  const preview = $("preview");
  const btnCopy = $("btnCopy");
  const btnCopyOnly = $("btnCopyOnly");
  const btnSummary = $("btnSummary");
  const btnResetForm = $("btnResetForm");

  const histList = $("histList");
  const histCount = $("histCount");
  const histHint = $("histHint");
  const btnToggleAll = $("btnToggleAll");
  const btnClearAll = $("btnClearAll");

  const toast = $("toast");

  const modalBack = $("modalBack");
  const modalTitle = $("modalTitle");
  const modalText = $("modalText");
  const modalClose = $("modalClose");
  const modalYes = $("modalYes");
  const modalNo = $("modalNo");

  /* =========================
     State
  ========================== */
  let history = [];
  let selectedIds = new Set();
  let showAllHistory = false;

  let modalOnYes = null;

  /* =========================
     Helpers
  ========================== */
  const pad2 = (n) => String(n).padStart(2, "0");

  function todayISO(){
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function parseISODate(iso){
    if (!iso) return null;
    const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return null;
    const y = Number(m[1]), mo = Number(m[2])-1, da = Number(m[3]);
    const d = new Date(y, mo, da);
    if (!Number.isFinite(d.getTime())) return null;
    return d;
  }

  function formatReportDateBuddhist2(d){
    const dd = pad2(d.getDate());
    const mm = pad2(d.getMonth()+1);
    const be = d.getFullYear() + 543;
    const yy = pad2(be % 100);
    return `${dd}/${mm}/${yy}`;
  }

  function formatSummaryDateGregorian4(d){
    const dd = pad2(d.getDate());
    const mm = pad2(d.getMonth()+1);
    const yyyy = d.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  }

  function formatDateTimeShort(ms){
    const d = new Date(ms);
    const dd = pad2(d.getDate());
    const mm = pad2(d.getMonth()+1);
    const yyyy = d.getFullYear();
    const HH = pad2(d.getHours());
    const Mi = pad2(d.getMinutes());
    return `${dd}/${mm}/${yyyy} ${HH}:${Mi}`;
  }

  function safeText(v){
    return String(v ?? "").replace(/\r\n/g, "\n").replace(/\r/g, "\n");
  }

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 1600);
  }

  function setStatus(type, text){
    if (type === "ok"){
      statusBadge.className = "badge ok";
      statusBadge.textContent = "‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    } else if (type === "err"){
      statusBadge.className = "badge err";
      statusBadge.textContent = "‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
    } else {
      statusBadge.className = "badge wait";
      statusBadge.textContent = "‚è≥ ‡∏û‡∏£‡πâ‡∏≠‡∏°";
    }
    statusText.textContent = text || "";
  }

  function openUrl(url){
    try{
      window.open(url, "_blank", "noopener,noreferrer");
    } catch (e){}
  }

  /* =========================
     ‚úÖ Embed-only UI trim
  ========================== */
  function applyEmbedModeUI(){
    if (!EMBED) return;

    // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î
    if (btnSummary) btnSummary.style.display = "none";

    // ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô
    const historyCard = document.getElementById("historyCard") || (histList && histList.closest(".card"));
    if (historyCard) historyCard.style.display = "none";

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô hint ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡∏Å‡∏±‡∏ô‡∏á‡∏á)
    setStatus("wait", "‡πÇ‡∏´‡∏°‡∏î Popup: ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î/‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß");
  }

  /* =========================
     Build Report Text
  ========================== */
  function buildReportText(){
    const d = parseISODate(reportDate.value) || new Date();
    const dateLine = formatReportDateBuddhist2(d);

    const a = safeText(account.value).trim();
    const bc = safeText(branchCode.value).trim();
    const bn = safeText(branchName.value).trim();
    const pogV = safeText(pog.value).trim() || "‡∏ï‡∏£‡∏á";
    const skuV = safeText(sku.value).trim() || "‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö";

    const oosV = safeText(oos.value).trimEnd();
    const issueV = safeText(issue.value).trimEnd();
    const noteV = safeText(note.value).trimEnd();

    return [
      `${dateLine}`,
      `${TEAM_REPORT}`,
      `‡πÅ‡∏≠‡∏Ñ‡πÄ‡∏Ñ‡∏≤‡∏ó‡πå : ${a}`,
      `‡πÄ‡∏•‡∏Ç‡∏™‡∏≤‡∏Ç‡∏≤ : ${bc}`,
      `‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤ : ${bn}`,
      `‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏° POG ‡∏ï‡∏£‡∏á/‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á : ${pogV}`,
      `‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å SKU‡πÑ‡∏´‡∏° ‡∏Ñ‡∏£‡∏ö/‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö : ${skuV}`,
      `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤OOS : `,
      `${oosV}`,
      ``,
      `‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô :`,
      `${issueV}`,
      ``,
      `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ :`,
      `${noteV}`
    ].join("\n");
  }

  function updatePreview(){
    const text = buildReportText();
    preview.textContent = text;
  }

  /* =========================
     Clipboard (robust)
  ========================== */
  async function copyToClipboard(text){
    const t = String(text ?? "");
    try{
      if (navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(t);
        return true;
      }
    } catch (e){}

    try{
      const ta = document.createElement("textarea");
      ta.value = t;
      ta.setAttribute("readonly", "");
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      ta.style.top = "-9999px";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      ta.setSelectionRange(0, ta.value.length);
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return !!ok;
    } catch (e){
      return false;
    }
  }

  /* =========================
     Local Storage
  ========================== */
  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      return JSON.parse(raw);
    } catch {
      return fallback;
    }
  }

  function saveJSON(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }

  function saveFormState(){
    // ‚úÖ Embed mode: ‡∏´‡πâ‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å account/branchCode/branchName ‡∏•‡∏á localStorage
    // ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞ "‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°" ‡∏Ç‡∏≠‡∏á 3 ‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏ß‡πâ (‡πÑ‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö)
    const base = loadJSON(STORE_FORM, {}) || {};
    const data = {
      ...base,
      pog: pog.value || "‡∏ï‡∏£‡∏á",
      sku: sku.value || "‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö",
      oos: oos.value || "",
      issue: issue.value || "",
      note: note.value || "",
      autoOpenLine: !!autoOpenLine.checked
    };

    if (!EMBED){
      data.account = account.value || "";
      data.branchCode = branchCode.value || "";
      data.branchName = branchName.value || "";
    }

    saveJSON(STORE_FORM, data);
  }

  function loadFormState(){
    const data = loadJSON(STORE_FORM, null);
    if (!data) return;

    // ‚úÖ Embed mode: ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î 3 ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å localStorage (‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ)
    if (!EMBED){
      account.value = data.account || "";
      branchCode.value = data.branchCode || "";
      branchName.value = data.branchName || "";
    } else {
      account.value = "";
      branchCode.value = "";
      branchName.value = "";
    }

    pog.value = data.pog || "‡∏ï‡∏£‡∏á";
    sku.value = data.sku || "‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö";
    oos.value = data.oos || "";
    issue.value = data.issue || "";
    note.value = data.note || "";
    autoOpenLine.checked = !!data.autoOpenLine;
  }

  function loadUIState(){
    const ui = loadJSON(STORE_UI, {});
    showAllHistory = !!ui.showAllHistory;
    selectedIds = new Set(Array.isArray(ui.selectedIds) ? ui.selectedIds : []);
  }

  function saveUIState(){
    saveJSON(STORE_UI, {
      showAllHistory,
      selectedIds: Array.from(selectedIds)
    });
  }

  function loadHistory(){
    const arr = loadJSON(STORE_HISTORY, []);
    history = Array.isArray(arr) ? arr : [];
  }

  function saveHistory(){
    saveJSON(STORE_HISTORY, history);
  }

  /* =========================
     History CRUD
  ========================== */
  function makeId(){
    return `${Date.now()}_${Math.random().toString(16).slice(2)}`;
  }

  function addHistoryEntry(reportText){
    // ‚úÖ Embed mode: ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
    const id = makeId();
    const createdAt = Date.now();
    const reportDateISO = reportDate.value || todayISO();

    const entry = {
      id,
      createdAt,
      reportDateISO,
      reportText,
      account: safeText(account.value).trim(),
      branchCode: safeText(branchCode.value).trim(),
      branchName: safeText(branchName.value).trim(),
    };

    history.unshift(entry);
    saveHistory();
    renderHistory();
    return entry;
  }

  function deleteHistoryEntry(id){
    history = history.filter(x => x.id !== id);
    selectedIds.delete(id);
    saveHistory();
    saveUIState();
    renderHistory();
  }

  function clearAllHistory(){
    history = [];
    selectedIds.clear();
    saveHistory();
    saveUIState();
    renderHistory();
  }

  /* =========================
     Render History
  ========================== */
  function renderHistory(){
    if (EMBED){
      // ‡πÇ‡∏´‡∏°‡∏î embed ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á render ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
      return;
    }

    const total = history.length;
    histCount.textContent = `${total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

    const selectedCount = Array.from(selectedIds).filter(id => history.some(h => h.id === id)).length;
    histHint.textContent = selectedCount > 0
      ? `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ ${selectedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÉ‡∏ä‡πâ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)`
      : `‡∏ï‡∏¥‡πä‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ ‚Äú‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‚Äù`;

    btnToggleAll.textContent = showAllHistory ? "‡∏¢‡πà‡∏≠ (30 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)" : "‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)";

    const list = showAllHistory ? history : history.slice(0, 30);

    histList.innerHTML = "";
    if (list.length === 0){
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‚Äî ‡∏Å‡∏î COPY ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ";
      histList.appendChild(empty);
      return;
    }

    for (const item of list){
      const wrap = document.createElement("div");
      wrap.className = "histItem";

      const row = document.createElement("div");
      row.className = "histRow";

      const left = document.createElement("div");
      left.className = "histLeft";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.className = "check";
      cb.checked = selectedIds.has(item.id);
      cb.addEventListener("change", () => {
        if (cb.checked) selectedIds.add(item.id);
        else selectedIds.delete(item.id);
        saveUIState();
        renderHistory();
      });

      const main = document.createElement("div");
      main.className = "histMain";

      const title = document.createElement("div");
      title.className = "histTitle";
      const tAcc = item.account || "(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏≠‡∏Ñ‡πÄ‡∏Ñ‡∏≤‡∏ó‡πå)";
      const tBc = item.branchCode || "(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏™‡∏≤‡∏Ç‡∏≤)";
      const tBn = item.branchName || "(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤)";
      title.textContent = `${tAcc} ${tBc} ${tBn}`.trim();

      const meta = document.createElement("div");
      meta.className = "histMeta";
      meta.textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${formatDateTimeShort(item.createdAt)} ‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${item.reportDateISO || "-"}`;

      main.appendChild(title);
      main.appendChild(meta);

      left.appendChild(cb);
      left.appendChild(main);

      const actions = document.createElement("div");
      actions.className = "histActions";

      const btnCopyAgain = document.createElement("button");
      btnCopyAgain.className = "btn soft";
      btnCopyAgain.textContent = "üìã COPY";
      btnCopyAgain.addEventListener("click", async () => {
        const ok = await copyToClipboard(item.reportText || "");
        if (ok){
          setStatus("ok", "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß");
          showToast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
        } else {
          setStatus("err", "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)");
          showToast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ùå");
        }

        if (autoOpenLine.checked){
          const url = getLineUrlByAccount(item.account);
          openUrl(url);
          showToast("‡πÄ‡∏õ‡∏¥‡∏î LINE ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß");
        }
      });

      const btnDel = document.createElement("button");
      btnDel.className = "btn danger";
      btnDel.textContent = "üóë ‡∏•‡∏ö";
      btnDel.addEventListener("click", () => {
        openConfirm(
          "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
          `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?\n\n${(item.account||"")} ${(item.branchCode||"")} ${(item.branchName||"")}`.trim(),
          () => deleteHistoryEntry(item.id)
        );
      });

      actions.appendChild(btnCopyAgain);
      actions.appendChild(btnDel);

      row.appendChild(left);
      row.appendChild(actions);
      wrap.appendChild(row);

      histList.appendChild(wrap);
    }
  }

  /* =========================
     Confirm Modal
  ========================== */
  function openConfirm(title, text, onYes){
    modalTitle.textContent = title || "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô";
    modalText.textContent = text || "-";
    modalOnYes = typeof onYes === "function" ? onYes : null;
    modalBack.style.display = "flex";
    modalBack.setAttribute("aria-hidden", "false");
  }
  function closeConfirm(){
    modalBack.style.display = "none";
    modalBack.setAttribute("aria-hidden", "true");
    modalOnYes = null;
  }

  modalClose.addEventListener("click", closeConfirm);
  modalNo.addEventListener("click", closeConfirm);
  modalYes.addEventListener("click", () => {
    try{ modalOnYes && modalOnYes(); } finally { closeConfirm(); }
  });
  modalBack.addEventListener("click", (e) => {
    if (e.target === modalBack) closeConfirm();
  });

  /* =========================
     Copy Flow
  ========================== */
  function validateForCopy(){
    const missing = [];
    if (!account.value) missing.push("‡πÅ‡∏≠‡∏Ñ‡πÄ‡∏Ñ‡∏≤‡∏ó‡πå");
    if (!branchCode.value.trim()) missing.push("‡πÄ‡∏•‡∏Ç‡∏™‡∏≤‡∏Ç‡∏≤");
    if (!branchName.value.trim()) missing.push("‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤");
    return missing;
  }

  async function doCopy({openLine=true} = {}){
    updatePreview();
    const text = preview.textContent || buildReportText();

    const miss = validateForCopy();
    if (miss.length){
      setStatus("wait", `‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å ${miss.join(", ")} (‡πÅ‡∏ï‡πà‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß)`);
    }

    const ok = await copyToClipboard(text);
    if (ok){
      setStatus("ok", "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
      showToast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
      if (!EMBED) addHistoryEntry(text);
    } else {
      setStatus("err", "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)");
      showToast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ùå");
      return;
    }

    saveFormState();

    if (openLine && autoOpenLine.checked){
      const url = getLineUrlByAccount(account.value);
      openUrl(url);
      showToast("‡πÄ‡∏õ‡∏¥‡∏î LINE ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß");
    }
  }

  /* =========================
     Summary Flow
  ========================== */
  function buildSummaryText(){
    const d = parseISODate(reportDate.value) || new Date();
    const dateLine = formatSummaryDateGregorian4(d);

    const selectedItems = history.filter(h => selectedIds.has(h.id));
    selectedItems.sort((a,b) => (a.createdAt||0) - (b.createdAt||0));

    const lines = [];
    lines.push(`‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateLine}`);
    lines.push(`${TEAM_SUMMARY}`);
    lines.push("");

    selectedItems.forEach((it, idx) => {
      const a = (it.account || "").trim();
      const bc = (it.branchCode || "").trim();
      const bn = (it.branchName || "").trim();
      lines.push(`${idx+1}. ${[a, bc, bn].filter(Boolean).join(" ").trim()}`);
    });

    return { text: lines.join("\n"), count: selectedItems.length };
  }

  async function doSummary(){
    if (EMBED) return;

    const { text, count } = buildSummaryText();
    if (count <= 0){
      setStatus("wait", "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥");
      showToast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‚ùó");
      return;
    }

    const ok = await copyToClipboard(text);
    if (ok){
      setStatus("ok", `‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡πâ‡∏ß (${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
      showToast(`‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚úÖ (${count})`);
    } else {
      setStatus("err", "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      showToast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ùå");
      return;
    }

    openUrl(LINE_GROUPS.summary);
    showToast("‡πÄ‡∏õ‡∏¥‡∏î LINE ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
    saveUIState();
  }

  /* =========================
     Events (Form -> persist)
  ========================== */
  function bindSaveOnInput(el){
    el.addEventListener("input", () => {
      saveFormState();
      updatePreview();
    });
    el.addEventListener("change", () => {
      saveFormState();
      updatePreview();
    });
  }

  reportDate.addEventListener("change", () => updatePreview());

  bindSaveOnInput(account);
  bindSaveOnInput(branchCode);
  bindSaveOnInput(branchName);
  bindSaveOnInput(pog);
  bindSaveOnInput(sku);
  bindSaveOnInput(oos);
  bindSaveOnInput(issue);
  bindSaveOnInput(note);
  bindSaveOnInput(autoOpenLine);

  btnCopy.addEventListener("click", () => doCopy({openLine:true}));
  btnCopyOnly.addEventListener("click", () => doCopy({openLine:false}));
  if (btnSummary) btnSummary.addEventListener("click", doSummary);

  if (btnToggleAll) btnToggleAll.addEventListener("click", () => {
    showAllHistory = !showAllHistory;
    saveUIState();
    renderHistory();
  });

  if (btnClearAll) btnClearAll.addEventListener("click", () => {
    if (!history.length){
      showToast("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á");
      return;
    }
    openConfirm(
      "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
      `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?\n(‡∏à‡∏∞‡∏•‡∏ö ${history.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`,
      () => clearAllHistory()
    );
  });

  btnResetForm.addEventListener("click", () => {
    openConfirm(
      "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°",
      "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?\n(‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö)",
      () => {
        account.value = "";
        branchCode.value = "";
        branchName.value = "";
        pog.value = "‡∏ï‡∏£‡∏á";
        sku.value = "‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö";
        oos.value = "";
        issue.value = "";
        note.value = "";
        saveFormState();
        updatePreview();
        setStatus("wait", "‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß");
        showToast("‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß");
      }
    );
  });

  /* =========================
     ‚úÖ Prefill via postMessage (100% ‡πÑ‡∏°‡πà‡πÄ‡∏î‡∏≤ selector)
     Parent -> iframe:
       { type:"PT_PREFILL", payload:{ account, branchCode, branchName } }
  ========================== */
  function applyPrefill(payload){
    payload = payload || {};
    const a = String(payload.account ?? "").trim();
    const bc = String(payload.branchCode ?? "").trim();
    const bn = String(payload.branchName ?? "").trim();

    // ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÜ (id ‡∏ä‡∏±‡∏ß‡∏£‡πå)
    if (a) account.value = a;
    if (bc) branchCode.value = bc;
    if (bn) branchName.value = bn;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï preview ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    updatePreview();
    setStatus("wait", "Prefill ‡πÅ‡∏•‡πâ‡∏ß (Popup)");

    // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏ô EMBED ‡πÇ‡∏´‡∏°‡∏î saveFormState ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô 3 ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏•‡∏á localStorage ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÇ‡∏î‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å‡πá‡∏¢‡∏±‡∏á save ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
  }

  window.addEventListener("message", (e) => {
    const msg = e && e.data;
    if (!msg || msg.type !== "PT_PREFILL") return;

    // ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô: ‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ origin ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    try{
      if (location.origin && e.origin && e.origin !== location.origin) return;
    }catch(err){}

    applyPrefill(msg.payload || {});
    try{
      window.parent && window.parent.postMessage({ type:"PT_PREFILL_ACK" }, (location.origin || "*"));
    }catch(err){}
  });

  /* =========================
     Boot
  ========================== */
  function boot(){
    loadFormState();
    if (!EMBED){
      loadHistory();
      loadUIState();
    }

    reportDate.value = todayISO();

    if (localStorage.getItem(STORE_FORM) === null){
      autoOpenLine.checked = true;
      saveFormState();
    }

    updatePreview();
    applyEmbedModeUI();

    if (!EMBED){
      renderHistory();
    }

    if (!EMBED){
      setStatus("wait", "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
    }
  }

  boot();
})();
</script>
</body>
</html>

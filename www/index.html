<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>GBKK Tracker</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#f4fbf9;
      --card:#ffffff;
      --text:#071915;
      --muted:#3b6760;
      --line:rgba(7,25,21,.12);
      --mint:#14b8a6;
      --mint2:#0ea293;
      --shadow:0 10px 26px rgba(0,0,0,.08);
      --r:18px;
      --tap:44px;
      --danger:#e23a3a;

      --bottomTabsH:76px;

      --hdrH: 0px;
      --tabsH: var(--bottomTabsH);

      --sbW: 290px;
      --sbZ: 100001;

      --repZ: 100002;
      --repBarH: 56px;

      --setZ: 100003;
      --setBarH: 56px;
    }
    *{box-sizing:border-box}
    html, body{ height:100%; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#e9fbf7,var(--bg));
      color:var(--text);
      overflow-x:hidden;
    }
    body.rep-open{ overflow:hidden; }
    body.map-open{ overflow:hidden; }
    body.set-open{ overflow:hidden; }

    header{
      position:sticky; top:0; z-index:99997;
      background:linear-gradient(90deg,#0f8f83,#0b7c73);
      color:#fff;
      padding: calc(10px + env(safe-area-inset-top)) 14px 10px;
      box-shadow:0 10px 24px rgba(0,0,0,.14);
    }
    .hdr{ display:flex; gap:10px; align-items:center; }
    .hdr + .hdr{ margin-top:8px; }

    .topbar .titlewrap{ flex:1; min-width:0; }
    .topbar .rightbox{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }

    .menu-btn{
      min-height:40px;
      min-width:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.14);
      color:#fff;
      font-weight:1000;
      font-size:18px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .menu-btn:active{ transform:scale(.99); }

    .title{
      font-weight:1000;
      font-size:17px;
      display:flex; gap:8px; align-items:center;
      line-height:1.15;
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #projTitle{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      display:inline-block;
    }

    .tstats{
      display:block;
      width:100%;
      text-align:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.14);
      font-weight:1000;
      font-size:12px;
      line-height:1.2;
      white-space:normal;
      overflow-wrap:anywhere;
    }

    .badge{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.16);
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      display:flex;
      align-items:center;
      gap:8px;
      min-height:40px;
    }
    .icon-btn{
      min-height:34px;
      min-width:34px;
      width:34px;
      height:34px;
      padding:0;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.14);
      color:#fff;
      font-weight:1000;
      font-size:16px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .icon-btn:active{ transform:scale(.99); }
    .icon-btn[disabled]{ opacity:.6; cursor:not-allowed; pointer-events:none; }

    .btn-map{
      min-height:40px;
      border-radius:16px;
      border:1px solid rgba(15,143,131,.25);
      background:linear-gradient(90deg,#0f8f83,#0b7c73);
      color:#fff;
      padding:10px 12px;
      font-weight:1000;
      font-size:14px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .btn-map:active{ transform:scale(.99); }

    .controls{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .sheetpick{
      position:relative;
      flex:0 0 auto;
    }
    .sortpick{
      position:relative;
      flex:0 0 auto;
    }

    .sheetbtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      min-height:var(--tap);
      border-radius:14px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.14);
      color:#fff;
      padding:10px 12px;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .sheetbtn:active{transform:scale(.99)}

    .pickrow .sheetpick,
    .pickrow .sortpick{
      flex:1 1 0;
      min-width:0;
    }
    .pickrow .sheetbtn{
      width:100%;
      justify-content:space-between;
      min-width:0;
    }
    #sheetBtn span,
    #sortBtn span{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      display:inline-block;
    }

    .sheetdrop{
      position:absolute;
      left:0;
      top: calc(100% + 10px);
      width:min(380px, calc(100vw - 28px));
      background:#fff;
      color:var(--text);
      border-radius:18px;
      border:1px solid rgba(0,0,0,.10);
      box-shadow:0 20px 60px rgba(0,0,0,.22);
      padding:10px;
      display:none;
      z-index:100010;
    }
    .sortpick .sheetdrop{ left:auto; right:0; }
    .sheetdrop.show{ display:block; }

    .sheetsearch{
      min-height:44px;
      display:flex; align-items:center; gap:10px;
      border-radius:16px;
      border:1px solid rgba(7,25,21,.10);
      background:rgba(7,25,21,.04);
      padding:10px 12px;
      color:var(--muted);
    }
    .sheetsearch input{
      width:100%;
      border:none; outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
      font-weight:900;
    }
    .sheetsearch input::placeholder{ color:rgba(59,103,96,.75); }

    .sheetlist{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:46vh;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom:2px;
    }

    .sheetitem{
      width:100%;
      min-height:44px;
      border-radius:16px;
      border:1px solid rgba(20,184,166,.22);
      background:rgba(20,184,166,.10);
      color:#064e46;
      padding:10px 12px;
      font-weight:1000;
      font-size:14px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      text-align:left;
    }
    .sheetitem.active{
      background:linear-gradient(90deg,#0f8f83,#0b7c73);
      border-color:rgba(15,143,131,.25);
      color:#fff;
    }
    .sheetitem:active{ transform:scale(.99); }
    .sheethint{
      margin-top:8px;
      text-align:center;
      color:rgba(59,103,96,.85);
      font-weight:900;
      font-size:12px;
    }

    .search{
      flex:1 1 auto;
      width:100%;
      min-height:var(--tap);
      display:flex; align-items:center; gap:10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.14);
      padding:10px 12px;
      min-width:0;
    }
    .search input{
      width:100%;
      border:none; outline:none;
      background:transparent;
      color:#fff;
      font-size:16px;
      min-width:0;
    }
    .search input::placeholder{color:rgba(255,255,255,.78)}

    select, button{
      min-height:var(--tap);
      border-radius:14px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.14);
      color:#fff;
      padding:10px 12px;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{transform:scale(.99)}
    .btn-solid{
      background:rgba(255,255,255,.92);
      color:#0b2f2a;
      border-color:rgba(255,255,255,.92);
    }
    .btn-danger{
      background:rgba(226,58,58,.18);
      color:#fff;
      border-color:rgba(255,255,255,.25);
    }

    main{
      max-width:920px;
      margin:0 auto;
      padding:14px;
      padding-bottom: calc(14px + var(--bottomTabsH) + env(safe-area-inset-bottom));
    }

    .page{ display:none; }
    .page.active{ display:block; }

    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panel-h{
      padding:12px 14px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#fff,#fbfffe);
    }
    .panel-h strong{font-size:14px}
    .meta{
      margin-left:auto;
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }

    .list{display:flex; flex-direction:column}
    .item{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
    }
    .item:last-child{border-bottom:none}
    .name{
      font-weight:1000;
      font-size:15px;
      line-height:1.25;
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      font-weight:900;
    }
    .warn{color:#b05a00}
    .actions{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .a-btn{
      min-height:var(--tap);
      border-radius:14px;
      border:1px solid rgba(20,184,166,.28);
      background:rgba(20,184,166,.12);
      color:#064e46;
      padding:10px 12px;
      font-weight:1000;
      font-size:14px;
      cursor:pointer;
    }
    .a-btn[disabled]{opacity:.6; cursor:not-allowed}
    .a-nav{background:rgba(20,184,166,.14)}
    .a-done{background:rgba(20,184,166,.18)}
    .a-report{
      border-color:rgba(7,25,21,.12);
      background:rgba(7,25,21,.04);
      color:#071915;
    }

    .center{
      padding:22px 14px;
      text-align:center;
      color:var(--muted);
      font-weight:1000;
    }
    .spinner{
      width:46px; height:46px;
      border-radius:999px;
      border:5px solid rgba(20,184,166,.18);
      border-top-color:var(--mint);
      margin:0 auto 12px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .map-wrap{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .map-h{
      padding:12px 14px;
      display:flex; gap:10px; align-items:center;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#fff,#fbfffe);
      flex-wrap:wrap;
    }
    .map-h strong{font-size:14px}
    .pills{
      margin-left:auto;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(20,184,166,.30);
      background:rgba(20,184,166,.12);
      color:#064e46;
      font-size:12px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .pill:active{ transform:scale(.99); }
    #map{height:72vh; min-height:360px; width:100%}

    body.map-open main{
      height: calc(100vh - var(--hdrH) - var(--tabsH));
      overflow:hidden;
      padding-bottom: 14px;
    }
    body.map-open #pageMap.active{ height:100%; }
    body.map-open #pageMap.active .map-wrap{ height:100%; display:flex; flex-direction:column; }
    body.map-open #pageMap.active #map{ flex:1 1 auto; height:auto; min-height:0; width:100%; }

    .backdrop{
      position:fixed; inset:0;
      display:none; align-items:center; justify-content:center;
      padding:16px;
      background:rgba(0,0,0,.45);
      z-index:99999;
    }
    .modal{
      width:min(560px,100%);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(0,0,0,.10);
      box-shadow:0 20px 60px rgba(0,0,0,.22);
      overflow:hidden;
    }
    .modal h3{
      margin:0;
      padding:14px 14px 8px;
      font-size:16px;
      font-weight:1000;
    }
    .modal .body{
      padding:0 14px 14px;
      color:#23443f;
      font-weight:900;
      white-space:pre-line;
      font-size:14px;
    }
    .m-actions{
      padding:12px 14px;
      border-top:1px solid rgba(0,0,0,.10);
      display:flex; justify-content:flex-end; gap:10px;
    }
    .m-btn{
      min-height:var(--tap);
      border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      background:#f0f5f4;
      color:#071915;
      padding:10px 12px;
      font-weight:1000;
      cursor:pointer;
    }
    .m-ok{
      background:rgba(20,184,166,.16);
      border-color:rgba(20,184,166,.35);
      color:#064e46;
    }
    .m-danger{
      background:rgba(226,58,58,.12);
      border-color:rgba(226,58,58,.28);
      color:#7b1111;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom: calc(18px + var(--bottomTabsH) + env(safe-area-inset-bottom));
      transform:translateX(-50%);
      display:none;
      max-width:min(560px,calc(100% - 24px));
      text-align:center;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(6,27,22,.88);
      color:#fff;
      font-weight:900;
      font-size:13px;
      z-index:100000;
    }

    .map-link{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(20,184,166,.35);
      background:rgba(20,184,166,.14);
      color:#064e46;
      font-weight:1000;
      text-decoration:none;
      min-height:40px;
      line-height:1;
      width:100%;
      cursor:pointer;
    }
    .map-actions{
      display:flex;
      gap:10px;
      margin-top:8px;
      flex-wrap:wrap;
    }
    .map-actions .map-link:active{ transform:scale(.99); }

    .map-done{
      border-color:rgba(226,58,58,.28);
      background:rgba(226,58,58,.10);
      color:#7b1111;
      cursor:pointer;
    }
    .map-report{
      border-color:rgba(7,25,21,.12);
      background:rgba(7,25,21,.04);
      color:#071915;
      cursor:pointer;
    }

    .map-link[disabled],
    .map-link.disabled{
      opacity:.6;
      cursor:not-allowed;
      pointer-events:none;
    }

    .me-icon{ background: transparent !important; border: none !important; }
    .me-dot{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #ffffff;
      border: 5px solid var(--mint);
      box-shadow: 0 0 0 6px rgba(20, 184, 166, .18);
      position: relative;
    }
    .me-dot::after{
      content:'';
      position:absolute;
      inset:-10px;
      border-radius:999px;
      border: 2px solid rgba(20, 184, 166, .35);
      animation: mePulse 1.6s ease-out infinite;
    }
    @keyframes mePulse{
      0%   { transform: scale(.65); opacity: .9; }
      100% { transform: scale(1.25); opacity: 0; }
    }

    .bottom-tabs{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index:99998;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(255,255,255,.92);
      border-top:1px solid rgba(7,25,21,.10);
      box-shadow:0 -10px 24px rgba(0,0,0,.10);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .bottom-tabs .row{
      max-width:920px;
      margin:0 auto;
      display:flex;
      gap:10px;
    }
    .tabbtn{
      flex:1;
      min-height:var(--tap);
      border-radius:16px;
      border:1px solid rgba(20,184,166,.28);
      background:rgba(20,184,166,.10);
      color:#064e46;
      padding:10px 12px;
      font-weight:1000;
      font-size:14px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .tabbtn.active{
      background:linear-gradient(90deg,#0f8f83,#0b7c73);
      border-color:rgba(15,143,131,.25);
      color:#fff;
    }
    .tabbtn:active{ transform:scale(.99); }

    .sb-overlay{
      position:fixed;
      inset:0;
      z-index:var(--sbZ);
      background:rgba(0,0,0,.38);
      display:none;
      touch-action: manipulation;
    }
    .sb-overlay.show{ display:block; }

    .sidebar{
      position:absolute;
      left:0; top:0; bottom:0;
      width:min(var(--sbW), calc(100% - 64px));
      background:linear-gradient(180deg,#ffffff,#f6fffd);
      border-right:1px solid rgba(7,25,21,.10);
      box-shadow: 18px 0 40px rgba(0,0,0,.18);
      transform:translateX(-104%);
      transition:transform .22s ease;
      padding:12px;
      padding-top: calc(12px + env(safe-area-inset-top));
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .sb-overlay.show .sidebar{ transform:translateX(0); }

    .sb-body{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom:10px;
    }

    .sb-head{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 6px 12px;
      border-bottom:1px solid rgba(7,25,21,.10);
      margin-bottom:12px;
    }
    .sb-title{
      font-weight:1000;
      color:#071915;
      font-size:16px;
    }
    .sb-close{
      margin-left:auto;
      min-height:40px;
      border-radius:14px;
      border:1px solid rgba(20,184,166,.25);
      background:rgba(20,184,166,.10);
      color:#064e46;
      padding:8px 12px;
      font-weight:1000;
      cursor:pointer;
    }

    .sb-section{
      margin-top:12px;
      font-weight:1000;
      font-size:12px;
      color:#3b6760;
      letter-spacing:.2px;
      text-transform:uppercase;
      padding:0 6px;
    }

    .sb-link{
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
      margin-top:10px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(20,184,166,.22);
      background:rgba(20,184,166,.10);
      color:#064e46;
      font-weight:1000;
      text-decoration:none;
      cursor:pointer;
    }
    button.sb-link{
      text-align:left;
      appearance:none;
      -webkit-appearance:none;
    }
    .sb-link:active{ transform:scale(.99); }
    .sb-ico{
      width:34px; height:34px;
      border-radius:12px;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(20,184,166,.22);
      display:flex; align-items:center; justify-content:center;
      font-size:18px;
      flex:0 0 auto;
    }
    .sb-text{
      display:flex;
      flex-direction:column;
      line-height:1.15;
      min-width:0;
    }
    .sb-text small{
      font-weight:900;
      color:rgba(6,78,70,.75);
      margin-top:4px;
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sb-footer{
      margin-top:auto;
      padding-top:10px;
      border-top:1px solid rgba(7,25,21,.10);
    }

    .rep-overlay{
      position:fixed;
      inset:0;
      z-index:var(--repZ);
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:10px;
    }
    .rep-overlay.show{ display:flex; }
    .rep-modal{
      width:min(1200px, 100%);
      height:min(92vh, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(0,0,0,.10);
      box-shadow:0 20px 70px rgba(0,0,0,.28);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .rep-bar{
      height:var(--repBarH);
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      background:linear-gradient(90deg,#0f8f83,#0b7c73);
      color:#fff;
    }
    .rep-title{
      font-weight:1000;
      white-space:nowrap;
    }
    .rep-sub{
      font-weight:900;
      font-size:12px;
      opacity:.92;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .rep-close{
      margin-left:auto;
      min-height:40px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.14);
      color:#fff;
      padding:8px 12px;
      font-weight:1000;
      cursor:pointer;
    }
    #repFrame{
      width:100%;
      height: calc(100% - var(--repBarH));
      border:0;
      background:#fff;
    }

    .set-overlay{
      position:fixed;
      inset:0;
      z-index:var(--setZ);
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:10px;
    }
    .set-overlay.show{ display:flex; }
    .set-modal{
      width:min(900px, 100%);
      height:min(92vh, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(0,0,0,.10);
      box-shadow:0 20px 70px rgba(0,0,0,.28);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .set-bar{
      height:var(--setBarH);
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      background:linear-gradient(90deg,#0f8f83,#0b7c73);
      color:#fff;
    }
    .set-title{
      font-weight:1000;
      white-space:nowrap;
    }
    .set-sub{
      font-weight:900;
      font-size:12px;
      opacity:.92;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .set-close{
      margin-left:auto;
      min-height:40px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.14);
      color:#fff;
      padding:8px 12px;
      font-weight:1000;
      cursor:pointer;
    }
    .set-body{
      padding:14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      background:linear-gradient(180deg,#fff,#fbfffe);
    }
    .set-card{
      background:#fff;
      border:1px solid rgba(7,25,21,.10);
      border-radius:18px;
      box-shadow:0 12px 24px rgba(0,0,0,.06);
      padding:14px;
    }
    .set-h{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:12px;
    }
    .set-h strong{
      font-weight:1000;
      color:#071915;
      font-size:14px;
    }
    .set-h small{
      font-weight:900;
      color:#3b6760;
      font-size:12px;
    }
    .seg{
      display:flex;
      gap:10px;
      padding:10px;
      border-radius:18px;
      border:1px solid rgba(20,184,166,.20);
      background:rgba(20,184,166,.08);
      flex-wrap:wrap;
    }
    .seg label{
      flex:1 1 240px;
      cursor:pointer;
      user-select:none;
    }
    .seg input{ display:none; }
    .seg .seg-pill{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-height:46px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(7,25,21,.10);
      background:#fff;
      color:#071915;
      font-weight:1000;
      font-size:14px;
      box-shadow:0 8px 16px rgba(0,0,0,.06);
    }
    .seg input:checked + .seg-pill{
      background:linear-gradient(90deg,#0f8f83,#0b7c73);
      border-color:rgba(15,143,131,.25);
      color:#fff;
    }
    .set-actions{
      padding:12px 14px;
      border-top:1px solid rgba(0,0,0,.10);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      background:#fff;
    }
    .set-btn{
      min-height:var(--tap);
      border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      background:#f0f5f4;
      color:#071915;
      padding:10px 12px;
      font-weight:1000;
      cursor:pointer;
    }
    .set-save{
      background:rgba(20,184,166,.16);
      border-color:rgba(20,184,166,.35);
      color:#064e46;
    }
  </style>
</head>

<body>

<div id="sbOverlay" class="sb-overlay" aria-hidden="true">
  <aside class="sidebar" role="navigation" aria-label="Tools Sidebar">
    <div class="sb-body">
      <div class="sb-head">
        <div class="sb-title">üß∞ Tools</div>
        <button id="sbClose" class="sb-close" type="button">‡∏õ‡∏¥‡∏î</button>
      </div>

      <div class="sb-section">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</div>

      <a class="sb-link" href="Tools/Report.html">
        <div class="sb-ico">üßæ</div>
        <div class="sb-text">
          Report Script
          <small>‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Report.html (‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤)</small>
        </div>
      </a>

      <a class="sb-link" href="Tools/Timestamp.html">
        <div class="sb-ico">‚è±Ô∏è</div>
        <div class="sb-text">
          Timestamp Camera
          <small>‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Timestamp.html (‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤)</small>
        </div>
      </a>
    </div>

    <div class="sb-footer">
      <button id="sbSettings" class="sb-link" type="button">
        <div class="sb-ico">‚öôÔ∏è</div>
        <div class="sb-text">
          Settings
          <small>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</small>
        </div>
      </button>
    </div>
  </aside>
</div>

<header>
  <div class="hdr topbar">
    <button id="btnMenu" class="menu-btn" type="button" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π">‚ò∞</button>

    <div class="titlewrap">
      <div class="title">üìç <span id="projTitle">GBKK Tracker</span></div>
    </div>

    <div class="rightbox">
      <div id="badge" class="badge">
        <span id="badgeText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</span>
        <button id="btnRefresh" class="icon-btn" type="button" aria-label="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä">‚ü≥</button>
      </div>
      <button id="btnResetAll" class="btn-map" type="button">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
  </div>

  <div class="hdr statsrow">
    <span id="titleStats" class="tstats">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Äî | ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‚Äî | ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚Äî</span>
  </div>

  <div class="hdr pickrow">
    <div class="sheetpick" id="sheetPicker">
      <button id="sheetBtn" class="sheetbtn" type="button">üóÇÔ∏è <span id="sheetLabel">‚Äî</span> ‚ñæ</button>
      <div id="sheetDrop" class="sheetdrop" aria-hidden="true">
        <div class="sheetsearch">
          üîé
          <input id="sheetSearch" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏µ‡∏ó‚Ä¶" autocomplete="off">
        </div>
        <div id="sheetList" class="sheetlist"></div>
        <div id="sheetHint" class="sheethint">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏µ‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà/‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>
      </div>
    </div>

    <div class="sortpick" id="sortPicker">
      <button id="sortBtn" class="sheetbtn" type="button">‚ÜïÔ∏è <span id="sortLabel">‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°</span> ‚ñæ</button>
      <div id="sortDrop" class="sheetdrop" aria-hidden="true">
        <div id="sortList" class="sheetlist"></div>
      </div>
    </div>

    <select id="sortMode" aria-label="‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö" style="position:absolute;left:-9999px;top:-9999px;width:1px;height:1px;opacity:0">
      <option value="default">‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°</option>
      <option value="nearest">‡πÉ‡∏Å‡∏•‡πâ‡∏â‡∏±‡∏ô</option>
    </select>
  </div>

  <div class="hdr searchrow">
    <div class="search">
      üîé
      <input id="q" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ID ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‚Ä¶" autocomplete="off">
    </div>
  </div>
</header>

<main>
  <section id="pageList" class="page active">
    <section class="panel">
      <div class="panel-h">
        <strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏õ</strong>
        <div id="meta" class="meta">‚Äî</div>
      </div>

      <div id="list" class="list">
        <div class="center">
          <div class="spinner"></div>
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶
        </div>
      </div>
    </section>
  </section>

  <section id="pageMap" class="page">
    <section class="map-wrap">
      <div class="map-h">
        <strong>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</strong>
        <div class="pills">
          <div id="fitPill" class="pill">‡∏à‡∏±‡∏î‡πÄ‡∏ü‡∏£‡∏°‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ</div>
          <div id="mePill" class="pill">‡πÑ‡∏õ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏â‡∏±‡∏ô</div>
          <div id="gpsPill" class="pill">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤ GPS</div>
        </div>
      </div>
      <div id="map"></div>
    </section>
  </section>
</main>

<nav class="bottom-tabs" role="tablist" aria-label="‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤">
  <div class="row">
    <button id="tabList" class="tabbtn active" type="button">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    <button id="tabMap" class="tabbtn" type="button">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
  </div>
</nav>

<div id="backdrop" class="backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="mTitle">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h3>
    <div id="mBody" class="body">‚Äî</div>
    <div class="m-actions">
      <button id="mCancel" class="m-btn" type="button">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button id="mOk" class="m-btn m-ok" type="button">‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>
  </div>
</div>

<div id="toast" class="toast">‚Äî</div>

<div id="repOverlay" class="rep-overlay" aria-hidden="true">
  <div class="rep-modal" role="dialog" aria-modal="true">
    <div class="rep-bar">
      <div class="rep-title">üßæ Report</div>
      <div id="repSub" class="rep-sub">‚Äî</div>
      <button id="repClose" class="rep-close" type="button">‡∏õ‡∏¥‡∏î</button>
    </div>
    <iframe id="repFrame" title="Report Popup" src=""></iframe>
  </div>
</div>

<div id="setOverlay" class="set-overlay" aria-hidden="true">
  <div class="set-modal" role="dialog" aria-modal="true">
    <div class="set-bar">
      <div class="set-title">‚öôÔ∏è Settings</div>
      <div class="set-sub">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</div>
      <button id="setClose" class="set-close" type="button">‡∏õ‡∏¥‡∏î</button>
    </div>

    <div class="set-body">
      <div class="set-card">
        <div class="set-h">
          <strong>Navigation Priority</strong>
          <small>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÉ‡∏´‡πâ ‚Äú‡∏•‡∏¥‡∏á‡∏Å‡πå‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äúlat/lng‚Äù ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å</small>
        </div>

        <div class="seg" role="radiogroup" aria-label="Navigation Priority">
          <label>
            <input type="radio" name="navPriority" value="linkFirst">
            <div class="seg-pill">‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Å‡πà‡∏≠‡∏ô (Link-first)</div>
          </label>
          <label>
            <input type="radio" name="navPriority" value="latLngFirst">
            <div class="seg-pill">‡πÉ‡∏ä‡πâ lat/lng ‡∏Å‡πà‡∏≠‡∏ô (LatLng-first)</div>
          </label>
        </div>
      </div>
    </div>

    <div class="set-actions">
      <button id="setCancel" class="set-btn" type="button">‡∏õ‡∏¥‡∏î</button>
      <button id="setSave" class="set-btn set-save" type="button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<script>
  const CONFIG = {
    API_URL: 'https://script.google.com/macros/s/AKfycbw91N5J4z1Jjn0rZz8qnn-ZFmP6bYJ2IZaKrOXrDaTj3aJoAvGJCVJBy982T_pXilNS/exec',
    REPORT_PATH: 'Tools/Report.html'
  };

  const REPORT_KEYS = {
    FORM: 'PT_REPORT_FORM_V1',
    HISTORY: 'PT_REPORT_HISTORY_V1'
  };

  const SETTINGS_KEY = 'PT_GBKK4_SETTINGS_V1';
  const SELECTED_SHEET_KEY = 'PT_GBKK_SELECTED_SHEET_V1';
  const CACHE_KEY_BASE = 'PT_GBKK_PLACES_CACHE_V1';
  const MAPSTATE_KEY = 'PT_GBKK4_MAPSTATE_V1';

  function $(id){ return document.getElementById(id); }

  function updateFixedHeights(){
    try{
      var hdr = document.querySelector('header');
      var tabs = document.querySelector('.bottom-tabs');
      if(hdr){ document.documentElement.style.setProperty('--hdrH', hdr.offsetHeight + 'px'); }
      if(tabs){ document.documentElement.style.setProperty('--tabsH', tabs.offsetHeight + 'px'); }
    }catch(e){}
  }

  function escapeHtml(s){
    s = (s === null || s === undefined) ? '' : String(s);
    return s.replace(/[&<>"']/g, function(m){
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
    });
  }

  function showToast(msg){
    var t = $('toast');
    t.textContent = msg;
    t.style.display = 'block';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(function(){ t.style.display='none'; }, 2200);
  }

  function debounce(fn, ms){
    var t = null;
    return function(){
      var args = arguments;
      clearTimeout(t);
      t = setTimeout(function(){ fn.apply(null, args); }, ms);
    };
  }

  function openModal(opts){
    opts = opts || {};
    $('mTitle').textContent = opts.title || '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
    $('mBody').textContent  = opts.body  || '‚Äî';
    $('mOk').textContent    = opts.okText || '‡∏ï‡∏Å‡∏•‡∏á';
    $('mCancel').textContent= opts.cancelText || '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
    $('mOk').className = 'm-btn ' + (opts.danger ? 'm-danger' : 'm-ok');

    $('backdrop').style.display = 'flex';
    $('backdrop').setAttribute('aria-hidden','false');

    return new Promise(function(resolve){
      function cleanup(){
        $('backdrop').style.display='none';
        $('backdrop').setAttribute('aria-hidden','true');
        $('mOk').onclick = null;
        $('mCancel').onclick = null;
      }
      $('mOk').onclick = function(){ cleanup(); resolve(true); };
      $('mCancel').onclick = function(){ cleanup(); resolve(false); };
    });
  }

  function openSidebar(){
    var o = $('sbOverlay');
    o.classList.add('show');
    o.setAttribute('aria-hidden','false');
  }
  function closeSidebar(){
    var o = $('sbOverlay');
    o.classList.remove('show');
    o.setAttribute('aria-hidden','true');
  }
  function sidebarIsOpen(){
    return $('sbOverlay').classList.contains('show');
  }

  $('btnMenu').addEventListener('click', function(e){
    e.stopPropagation();
    openSidebar();
  });
  $('sbClose').addEventListener('click', function(e){
    e.stopPropagation();
    closeSidebar();
  });
  $('sbOverlay').addEventListener('click', function(ev){
    if(ev.target && ev.target.id === 'sbOverlay'){ closeSidebar(); }
  });
  (function(){
    var links = $('sbOverlay').querySelectorAll('a.sb-link');
    links.forEach(function(a){
      a.addEventListener('click', function(){ closeSidebar(); });
    });
  })();

  function jsonp(url, timeoutMs){
    timeoutMs = timeoutMs || 15000;
    return new Promise(function(resolve, reject){
      var cbName = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*1e9);
      var timedOut = false;

      var timer = setTimeout(function(){
        timedOut = true;
        cleanup();
        reject(new Error('JSONP timeout'));
      }, timeoutMs);

      function cleanup(){
        clearTimeout(timer);
        try{ delete window[cbName]; }catch(e){ window[cbName] = undefined; }
        if(script && script.parentNode) script.parentNode.removeChild(script);
      }

      window[cbName] = function(data){
        if(timedOut) return;
        cleanup();
        resolve(data);
      };

      var sep = url.indexOf('?') >= 0 ? '&' : '?';
      var script = document.createElement('script');
      script.src = url + sep + 'callback=' + encodeURIComponent(cbName);
      script.onerror = function(){
        if(timedOut) return;
        cleanup();
        reject(new Error('JSONP load error'));
      };
      document.head.appendChild(script);
    });
  }

  function apiUrl(action, params){
    if(!CONFIG.API_URL || CONFIG.API_URL === 'PASTE_YOUR_APPS_SCRIPT_EXEC_URL_HERE'){ return ''; }
    var base = CONFIG.API_URL;
    var qs = 'action=' + encodeURIComponent(action);
    params = params || {};
    params._ts = Date.now();
    Object.keys(params).forEach(function(k){
      qs += '&' + encodeURIComponent(k) + '=' + encodeURIComponent(String(params[k]));
    });
    return base + (base.indexOf('?') >= 0 ? '&' : '?') + qs;
  }

  async function apiGetSheets(){
    var url = apiUrl('getSheets');
    if(!url) return { ok:false, message:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ CONFIG.API_URL' };
    return await jsonp(url);
  }

  async function apiGetPlaces(sheetName){
    var params = {};
    if(sheetName) params.sheet = sheetName;
    var url = apiUrl('getPlaces', params);
    if(!url) return { ok:false, message:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ CONFIG.API_URL' };
    return await jsonp(url);
  }

  async function apiMarkVisited(id, sheetName){
    var params = { id:id };
    if(sheetName) params.sheet = sheetName;
    var url = apiUrl('markVisited', params);
    if(!url) return { ok:false, message:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ CONFIG.API_URL' };
    return await jsonp(url);
  }

  async function apiResetVisitedAll(sheetName){
    var params = {};
    if(sheetName) params.sheet = sheetName;
    var url = apiUrl('resetVisitedAll', params);
    if(!url) return { ok:false, message:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ CONFIG.API_URL' };
    return await jsonp(url);
  }

  var SETTINGS = loadSettings_();

  function loadSettings_(){
    var def = { navPriority: 'linkFirst' };
    try{
      var raw = localStorage.getItem(SETTINGS_KEY);
      if(!raw) return def;
      var obj = JSON.parse(raw);
      if(!obj || typeof obj !== 'object') return def;
      var v = (obj.navPriority === 'latLngFirst') ? 'latLngFirst' : 'linkFirst';
      return { navPriority: v };
    }catch(e){
      return def;
    }
  }
  function saveSettings_(next){
    SETTINGS = next || SETTINGS;
    try{ localStorage.setItem(SETTINGS_KEY, JSON.stringify(SETTINGS)); }catch(e){}
  }

  function openSettings(){
    closeSidebar();
    var v = (SETTINGS && SETTINGS.navPriority) ? SETTINGS.navPriority : 'linkFirst';
    var radios = document.querySelectorAll('input[name="navPriority"]');
    radios.forEach(function(r){ r.checked = (r.value === v); });

    $('setOverlay').classList.add('show');
    $('setOverlay').setAttribute('aria-hidden','false');
    document.body.classList.add('set-open');
  }
  function closeSettings(){
    $('setOverlay').classList.remove('show');
    $('setOverlay').setAttribute('aria-hidden','true');
    document.body.classList.remove('set-open');
  }
  function saveSettingsFromUI(){
    var sel = document.querySelector('input[name="navPriority"]:checked');
    var v = sel ? String(sel.value) : 'linkFirst';
    v = (v === 'latLngFirst') ? 'latLngFirst' : 'linkFirst';
    saveSettings_({ navPriority: v });
    closeSettings();
    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
  }

  $('sbSettings').addEventListener('click', function(e){
    e.preventDefault();
    openSettings();
  });
  $('setClose').addEventListener('click', closeSettings);
  $('setCancel').addEventListener('click', closeSettings);
  $('setSave').addEventListener('click', saveSettingsFromUI);
  $('setOverlay').addEventListener('click', function(ev){
    if(ev.target && ev.target.id === 'setOverlay') closeSettings();
  });

  var SHEETS = [];
  var CURRENT_SHEET = '';

  function sheetKeyPart_(s){
    return String(s || '').replace(/[^\w‡∏Å-‡πô]/g, '_');
  }

  function projectTitleText_(){
    var s = CURRENT_SHEET ? String(CURRENT_SHEET) : 'GBKK';
    return s + ' Tracker';
  }

  function applyProjectTitle_(){
    var t = projectTitleText_();
    document.title = t;
    $('projTitle').textContent = t;
    $('sheetLabel').textContent = CURRENT_SHEET ? String(CURRENT_SHEET) : '‚Äî';
  }

  function openSheetDrop_(){
    closeSortDrop_();
    $('sheetDrop').classList.add('show');
    $('sheetDrop').setAttribute('aria-hidden','false');
    setTimeout(function(){
      try{ $('sheetSearch').focus(); }catch(e){}
    }, 0);
  }
  function closeSheetDrop_(){
    $('sheetDrop').classList.remove('show');
    $('sheetDrop').setAttribute('aria-hidden','true');
  }
  function sheetDropIsOpen_(){
    return $('sheetDrop').classList.contains('show');
  }

  function renderSheetList_(){
    var q = String($('sheetSearch').value || '').trim().toLowerCase();
    var arr = SHEETS.slice();

    if(q){
      arr = arr.filter(function(n){
        return String(n || '').toLowerCase().indexOf(q) !== -1;
      });
    }

    if(!arr.length){
      $('sheetList').innerHTML = '<div class="sheethint">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó</div>';
      return;
    }

    var html = '';
    for(var i=0;i<arr.length;i++){
      var name = String(arr[i] || '');
      var active = (name === String(CURRENT_SHEET));
      html +=
        '<button class="sheetitem' + (active ? ' active' : '') + '" type="button" data-sheet="' + escapeHtml(name) + '">' +
          '<span style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + escapeHtml(name) + '</span>' +
          (active ? '<span>‚úì</span>' : '<span style="opacity:.65"> </span>') +
        '</button>';
    }
    $('sheetList').innerHTML = html;
  }

  function setSelectedSheet_(name, persist){
    CURRENT_SHEET = String(name || '').trim();
    if(persist){
      try{ localStorage.setItem(SELECTED_SHEET_KEY, CURRENT_SHEET); }catch(e){}
    }
    $('sheetSearch').value = '';
    applyProjectTitle_();
    renderSheetList_();
    updateFixedHeights();
  }

  $('sheetBtn').addEventListener('click', function(e){
    e.preventDefault();
    e.stopPropagation();
    if(sheetDropIsOpen_()) closeSheetDrop_();
    else openSheetDrop_();
  });

  $('sheetSearch').addEventListener('input', renderSheetList_);

  $('sheetList').addEventListener('click', function(ev){
    var btn = ev.target && ev.target.closest ? ev.target.closest('button[data-sheet]') : null;
    if(!btn) return;
    var name = btn.getAttribute('data-sheet');
    if(!name) return;
    if(String(name) === String(CURRENT_SHEET)){
      closeSheetDrop_();
      return;
    }

    closeSheetDrop_();
    PENDING.clear();
    setSelectedSheet_(name, true);
    loadPlaces({ force:true });
  }, true);

  document.addEventListener('click', function(ev){
    if(!sheetDropIsOpen_()) return;
    var p = ev.target && ev.target.closest ? ev.target.closest('#sheetPicker') : null;
    if(!p) closeSheetDrop_();
  }, true);

  function openSortDrop_(){
    if(sheetDropIsOpen_()) closeSheetDrop_();
    $('sortDrop').classList.add('show');
    $('sortDrop').setAttribute('aria-hidden','false');
  }
  function closeSortDrop_(){
    if(!$('sortDrop')) return;
    $('sortDrop').classList.remove('show');
    $('sortDrop').setAttribute('aria-hidden','true');
  }
  function sortDropIsOpen_(){
    return $('sortDrop') && $('sortDrop').classList.contains('show');
  }

  function sortLabelFor_(v){
    v = String(v || '');
    if(v === 'nearest') return '‡πÉ‡∏Å‡∏•‡πâ‡∏â‡∏±‡∏ô';
    return '‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°';
  }

  function renderSortList_(){
    var cur = String($('sortMode').value || 'default');
    var items = [
      { value:'default', label:'‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°' },
      { value:'nearest', label:'‡πÉ‡∏Å‡∏•‡πâ‡∏â‡∏±‡∏ô' }
    ];
    var html = '';
    for(var i=0;i<items.length;i++){
      var it = items[i];
      var active = (String(it.value) === cur);
      html +=
        '<button class="sheetitem' + (active ? ' active' : '') + '" type="button" data-sort="' + escapeHtml(it.value) + '">' +
          '<span style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + escapeHtml(it.label) + '</span>' +
          (active ? '<span>‚úì</span>' : '<span style="opacity:.65"> </span>') +
        '</button>';
    }
    $('sortList').innerHTML = html;
    $('sortLabel').textContent = sortLabelFor_(cur);
  }

  function setSortMode_(v, fire){
    v = (String(v) === 'nearest') ? 'nearest' : 'default';
    var sel = $('sortMode');
    if(!sel) return;

    if(sel.value !== v){
      sel.value = v;
      $('sortLabel').textContent = sortLabelFor_(v);
      renderSortList_();
      if(fire){
        sel.dispatchEvent(new Event('change', { bubbles:true }));
      }
      updateFixedHeights();
      return;
    }

    $('sortLabel').textContent = sortLabelFor_(v);
    renderSortList_();
    updateFixedHeights();
  }

  $('sortBtn').addEventListener('click', function(e){
    e.preventDefault();
    e.stopPropagation();
    if(sortDropIsOpen_()) closeSortDrop_();
    else openSortDrop_();
  });

  $('sortList').addEventListener('click', function(ev){
    var btn = ev.target && ev.target.closest ? ev.target.closest('button[data-sort]') : null;
    if(!btn) return;
    var v = btn.getAttribute('data-sort');
    closeSortDrop_();
    setSortMode_(v, true);
  }, true);

  document.addEventListener('click', function(ev){
    if(!sortDropIsOpen_()) return;
    var p = ev.target && ev.target.closest ? ev.target.closest('#sortPicker') : null;
    if(!p) closeSortDrop_();
  }, true);

  function cacheKey_(sheetName){
    var s = (sheetName !== undefined && sheetName !== null) ? String(sheetName) : '';
    s = s || CURRENT_SHEET || 'default';
    return CACHE_KEY_BASE + '_' + sheetKeyPart_(s);
  }

  var META = { total:0, visited:0, remaining:0, rev:null };
  var PLACES = [];
  var PENDING = new Map();

  function renderTopStats(){
    $('titleStats').textContent =
      '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ' + META.total + ' | ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ' + META.remaining + ' | ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ' + META.visited;
    $('badgeText').textContent = (META.total ? ('‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ' + META.remaining + '/' + META.total) : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶');
  }

  var map = null;
  var placesLayer = null;
  var currentMarker = null;
  var currentLatLng = null;
  var meIcon = null;
  var markerById = new Map();

  var mapState = loadMapState_();

  function loadMapState_(){
    var def = { center:null, zoom:null, userInteracted:false, autoFitted:false };
    try{
      var raw = localStorage.getItem(MAPSTATE_KEY);
      if(!raw) return def;
      var obj = JSON.parse(raw);
      if(!obj || typeof obj !== 'object') return def;
      if(obj.center && typeof obj.center.lat === 'number' && typeof obj.center.lng === 'number' && typeof obj.zoom === 'number'){
        return { center: obj.center, zoom: obj.zoom, userInteracted:true, autoFitted:true };
      }
      return def;
    }catch(e){
      return def;
    }
  }

  function saveMapStateSoon_(){
    clearTimeout(saveMapStateSoon_._t);
    saveMapStateSoon_._t = setTimeout(function(){
      try{
        if(!mapState.center || typeof mapState.zoom !== 'number') return;
        localStorage.setItem(MAPSTATE_KEY, JSON.stringify({ center: mapState.center, zoom: mapState.zoom }));
      }catch(e){}
    }, 250);
  }

  function initMap(){
    if(map) return;
    try{
      map = L.map('map', { zoomControl:true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      placesLayer = L.layerGroup().addTo(map);

      meIcon = L.divIcon({
        className: 'me-icon',
        html: '<div class="me-dot"></div>',
        iconSize: [26, 26],
        iconAnchor: [13, 13]
      });

      if(mapState.center && typeof mapState.zoom === 'number'){
        map.setView([mapState.center.lat, mapState.center.lng], mapState.zoom);
      }else{
        map.setView([13.95, 100.40], 11);
      }

      map.on('dragstart', function(){ mapState.userInteracted = true; });
      map.on('zoomstart', function(){ mapState.userInteracted = true; });
      map.on('moveend zoomend', function(){
        try{
          var c = map.getCenter();
          mapState.center = { lat: c.lat, lng: c.lng };
          mapState.zoom = map.getZoom();
          saveMapStateSoon_();
        }catch(e){}
      });

      if(currentLatLng){
        setCurrentLocation(currentLatLng.lat, currentLatLng.lng);
      }
    }catch(e){
      console.error(e);
      showToast('‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
  }

  function setCurrentLocation(lat, lng){
    currentLatLng = { lat:lat, lng:lng };
    if(!map) return;

    if(currentMarker){
      try{ currentMarker.setLatLng([lat,lng]); }catch(e){}
      return;
    }

    currentMarker = L.marker([lat,lng], { icon: meIcon, zIndexOffset: 10000 })
      .addTo(map)
      .bindPopup('üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô');
  }

  function recenterToMe(){
    if(!map){ showToast('‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°'); return; }
    if(!currentLatLng){ showToast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏Å‡∏î GPS)'); return; }
    mapState.userInteracted = true;
    mapState.autoFitted = true;
    try{
      var z = map.getZoom();
      var nextZ = Math.max(16, z || 16);
      map.setView([currentLatLng.lat, currentLatLng.lng], nextZ, { animate:true });
    }catch(e){}
  }

  function haversineKm(a, b){
    var R = 6371;
    function toRad(x){ return x*Math.PI/180; }
    var dLat = toRad(b.lat - a.lat);
    var dLng = toRad(b.lng - a.lng);
    var la1 = toRad(a.lat);
    var la2 = toRad(a.lat);
    la2 = toRad(b.lat);
    var s = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(la1)*Math.cos(la2)*Math.sin(dLng/2)*Math.sin(dLng/2);
    return 2*R*Math.asin(Math.sqrt(s));
  }

  function hasLatLng_(p){
    return !!(p && p.lat !== null && p.lat !== undefined && p.lng !== null && p.lng !== undefined);
  }

  function getOpenLink(place){
    var mapsUrl = (place && place.mapsUrl) ? String(place.mapsUrl).trim() : '';
    var hasLL = hasLatLng_(place);

    function genFromLL(){
      var dest = place.lat + ',' + place.lng;
      return 'https://www.google.com/maps/dir/?api=1&destination=' + encodeURIComponent(dest) + '&travelmode=driving&dir_action=navigate';
    }

    var mode = (SETTINGS && SETTINGS.navPriority) ? SETTINGS.navPriority : 'linkFirst';

    if(mode === 'latLngFirst'){
      if(hasLL) return genFromLL();
      if(mapsUrl) return mapsUrl;
      return '';
    }

    if(mapsUrl) return mapsUrl;
    if(hasLL) return genFromLL();
    return '';
  }

  function openMaps(place){
    var url = getOpenLink(place);
    if(!url){ showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏≥‡∏ó‡∏≤‡∏á'); return; }
    window.open(url, '_blank');
  }

  function filteredPlaces(){
    var q = $('q').value.trim().toLowerCase();
    var arr = PLACES.slice();

    if(q){
      arr = arr.filter(function(p){
        var id = (p && p.id) ? String(p.id).toLowerCase() : '';
        var name = (p && p.name) ? String(p.name).toLowerCase() : '';
        return (id.indexOf(q) !== -1) || (name.indexOf(q) !== -1);
      });
    }

    var mode = $('sortMode').value;
    if(mode === 'nearest' && currentLatLng){
      arr = arr.map(function(p){
        var d = Number.POSITIVE_INFINITY;
        if(hasLatLng_(p)){
          d = haversineKm(currentLatLng, {lat:p.lat, lng:p.lng});
        }
        p._d = d;
        return p;
      }).sort(function(a,b){ return (a._d || 0) - (b._d || 0); });
    }

    return arr;
  }

  function renderHeader(){
    renderTopStats();
    $('meta').textContent = '‡∏£‡∏ß‡∏°: ' + META.total + ' | ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß: ' + META.visited;
  }

  function showLoading(){
    $('list').innerHTML =
      '<div class="center">' +
        '<div class="spinner"></div>' +
        '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶' +
      '</div>';
    $('badgeText').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶';
    $('titleStats').textContent = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Äî | ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‚Äî | ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚Äî';
  }

  var REPORT_CTX = null;
  var REPORT_FRAME_READY = false;
  var REPORT_TRIMMED = false;
  var REPORT_EMBED_PATCHED = false;
  var REPORT_COPY_HOOKED = false;

  function normText(s){
    return String(s || '').replace(/\s+/g,' ').trim().toLowerCase();
  }

  function openReport(place){
    REPORT_CTX = place || null;

    if(place){
      var subtitle = '[' + (place.id || '-') + '] ' + (place.name || '');
      var a = place.account ? (' | ' + place.account) : '';
      var n = place.number ? (' | ' + place.number) : '';
      var an = place.account_name ? (' | ' + place.account_name) : '';
      $('repSub').textContent = subtitle + a + n + an;
    }else{
      $('repSub').textContent = '‚Äî';
    }

    $('repOverlay').classList.add('show');
    $('repOverlay').setAttribute('aria-hidden','false');
    document.body.classList.add('rep-open');

    var frame = $('repFrame');
    var targetRel = CONFIG.REPORT_PATH + (CONFIG.REPORT_PATH.indexOf('?')>=0 ? '&' : '?') + 'embed=1';
    var targetAbs = '';
    try{ targetAbs = new URL(targetRel, location.href).href; }catch(e){ targetAbs = targetRel; }

    var curAbs = String(frame.src || '').split('#')[0];
    var curOk = false;
    try{ curOk = !!curAbs && curAbs.indexOf('about:blank') !== 0 && curAbs.indexOf(targetAbs) === 0; }catch(e){ curOk = false; }

    function afterFrameReady(){
      REPORT_FRAME_READY = true;
      tryTrimReportUI();
      patchReportEmbedStorageOnce();
      attachCopyHistoryHookOnce();
      clearRestrictedFieldsOnce();
      startPrefillLoop();
    }

    if(!curOk){
      REPORT_FRAME_READY = false;
      REPORT_TRIMMED = false;
      REPORT_EMBED_PATCHED = false;
      REPORT_COPY_HOOKED = false;

      frame.onload = function(){ afterFrameReady(); };

      var bust = targetAbs + (targetAbs.indexOf('?')>=0 ? '&' : '?') + 't=' + Date.now();
      frame.src = bust;
    }else{
      try{
        var d0 = getReportDoc();
        if(d0 && d0.body) REPORT_FRAME_READY = true;
      }catch(e){}
      afterFrameReady();
    }
  }

  function closeReport(){
    $('repOverlay').classList.remove('show');
    $('repOverlay').setAttribute('aria-hidden','true');
    document.body.classList.remove('rep-open');
  }

  $('repClose').addEventListener('click', closeReport);
  $('repOverlay').addEventListener('click', function(ev){
    if(ev.target && ev.target.id === 'repOverlay') closeReport();
  });

  function getReportDoc(){
    var frame = $('repFrame');
    try{ return frame.contentDocument || (frame.contentWindow && frame.contentWindow.document) || null; }
    catch(e){ return null; }
  }
  function getReportWin(){
    try{ return $('repFrame').contentWindow; }catch(e){ return null; }
  }

  function tryTrimReportUI(){
    if(REPORT_TRIMMED) return;
    var doc = getReportDoc();
    if(!doc || !doc.body) return;

    try{
      var btnSum = doc.getElementById('btnSummary');
      if(btnSum) btnSum.style.display = 'none';

      var histList = doc.getElementById('histList');
      if(histList){
        var card = histList.closest ? histList.closest('.card') : null;
        if(card) card.style.display = 'none';
      }

      var btns = doc.querySelectorAll('button, a, input[type="button"], input[type="submit"]');
      btns.forEach(function(el){
        var t = normText(el.textContent || el.value || '');
        if(t.indexOf('‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î') !== -1){ el.style.display = 'none'; }
      });

      REPORT_TRIMMED = true;
    }catch(e){}
  }

  function patchReportEmbedStorageOnce(){
    if(REPORT_EMBED_PATCHED) return;
    var win = getReportWin();
    if(!win || !win.localStorage) return;

    try{
      var LS = win.localStorage;
      if(LS.__pt_embed_patched){
        REPORT_EMBED_PATCHED = true;
        return;
      }

      var origSet = LS.setItem.bind(LS);
      var origGet = LS.getItem.bind(LS);

      function sanitizeForm(raw){
        try{
          var obj = JSON.parse(String(raw || '{}'));
          if(obj && typeof obj === 'object'){
            obj.account = '';
            obj.branchCode = '';
            obj.branchName = '';
            return JSON.stringify(obj);
          }
        }catch(e){}
        return raw;
      }

      LS.getItem = function(k){
        var v = origGet(k);
        if(String(k) === REPORT_KEYS.FORM && v){ return sanitizeForm(v); }
        return v;
      };

      LS.setItem = function(k, v){
        try{ if(String(k) === REPORT_KEYS.FORM){ v = sanitizeForm(v); } }catch(e){}
        return origSet(k, v);
      };

      LS.__pt_embed_patched = true;
      REPORT_EMBED_PATCHED = true;
    }catch(e){}
  }

  function findField(doc, ids, keywords){
    doc = doc || getReportDoc();
    if(!doc) return null;

    if(Array.isArray(ids)){
      for(var i=0;i<ids.length;i++){
        var el0 = doc.getElementById(ids[i]);
        if(el0) return el0;
      }
    }

    keywords = (keywords || []).map(function(x){ return normText(x); }).filter(Boolean);

    var labels = doc.querySelectorAll('label');
    for(var a=0;a<labels.length;a++){
      var lb = labels[a];
      var lt = normText(lb.textContent || '');
      if(!lt) continue;

      var hit = keywords.some(function(k){ return lt.indexOf(k) !== -1; });
      if(!hit) continue;

      var forId = lb.getAttribute('for');
      if(forId){
        var el1 = doc.getElementById(forId);
        if(el1) return el1;
      }

      var inside = lb.querySelector('input, textarea, select');
      if(inside) return inside;

      var near = lb.parentElement ? lb.parentElement.querySelector('input, textarea, select') : null;
      if(near) return near;
    }

    var fields = doc.querySelectorAll('input, textarea, select');
    for(var j=0;j<fields.length;j++){
      var f = fields[j];
      var meta = normText((f.getAttribute('placeholder')||'') + ' ' + (f.getAttribute('aria-label')||''));
      if(!meta) continue;
      var hit2 = keywords.some(function(k){ return meta.indexOf(k) !== -1; });
      if(hit2) return f;
    }

    return null;
  }

  function clearRestrictedFieldsOnce(){
    var doc = getReportDoc();
    var win = getReportWin();
    if(!doc || !win) return;

    var accEl  = findField(doc, ['account'], ['‡πÅ‡∏≠‡∏Ñ‡πÄ‡∏Ñ‡∏≤‡∏ó‡πå','account']);
    var numEl  = findField(doc, ['branchCode'], ['‡πÄ‡∏•‡∏Ç‡∏™‡∏≤‡∏Ç‡∏≤','‡∏™‡∏≤‡∏Ç‡∏≤','branch','store no','number']);
    var nameEl = findField(doc, ['branchName'], ['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô','store name','account name','‡∏ä‡∏∑‡πà‡∏≠']);

    [accEl, numEl, nameEl].forEach(function(el){
      if(!el) return;
      try{
        el.removeAttribute('readonly');
        el.removeAttribute('disabled');
        el.style.pointerEvents = 'auto';
      }catch(e){}
      try{
        el.value = '';
        el.dispatchEvent(new win.Event('input', { bubbles:true }));
        el.dispatchEvent(new win.Event('change', { bubbles:true }));
      }catch(e){}
    });
  }

  function prefillReportOnce(){
    var place = REPORT_CTX;
    if(!place) return false;

    var doc = getReportDoc();
    if(!doc || !doc.body) return false;

    var win = getReportWin();
    if(!win) return false;

    var acc = (place.account !== undefined && place.account !== null) ? String(place.account) : '';
    var num = (place.number !== undefined && place.number !== null) ? String(place.number) : '';
    var nam = (place.account_name !== undefined && place.account_name !== null) ? String(place.account_name) : '';

    var accEl  = findField(doc, ['account'], ['‡πÅ‡∏≠‡∏Ñ‡πÄ‡∏Ñ‡∏≤‡∏ó‡πå','account']);
    var numEl  = findField(doc, ['branchCode'], ['‡πÄ‡∏•‡∏Ç‡∏™‡∏≤‡∏Ç‡∏≤','‡∏™‡∏≤‡∏Ç‡∏≤','branch','store no','number']);
    var nameEl = findField(doc, ['branchName'], ['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô','store name','account name','‡∏ä‡∏∑‡πà‡∏≠']);

    function setVal(el, val){
      if(!el) return false;
      try{
        el.removeAttribute('readonly');
        el.removeAttribute('disabled');
        el.style.pointerEvents = 'auto';
      }catch(e){}
      try{
        el.value = val || '';
        el.dispatchEvent(new win.Event('input', { bubbles:true }));
        el.dispatchEvent(new win.Event('change', { bubbles:true }));
      }catch(e){}
      return true;
    }

    tryTrimReportUI();
    patchReportEmbedStorageOnce();
    attachCopyHistoryHookOnce();

    var okA = setVal(accEl, acc);
    var okN = setVal(numEl, num);
    var okS = setVal(nameEl, nam);

    return !!(okA || okN || okS);
  }

  function startPrefillLoop(){
    var tries = 0;
    var maxTries = 50;
    var interval = 120;

    var t = setInterval(function(){
      tries++;
      tryTrimReportUI();
      patchReportEmbedStorageOnce();
      attachCopyHistoryHookOnce();

      var ok = prefillReportOnce();
      if(ok || tries >= maxTries){
        clearInterval(t);
        if(!ok){ showToast('Prefill ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏ô Report.html (‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ)'); }
      }
    }, interval);
  }

  function attachCopyHistoryHookOnce(){
    if(REPORT_COPY_HOOKED) return;
    var doc = getReportDoc();
    var win = getReportWin();
    if(!doc || !win) return;

    try{
      var btn = doc.getElementById('btnCopy');
      if(!btn){
        var allBtns = doc.querySelectorAll('button');
        for(var i=0;i<allBtns.length;i++){
          var t = normText(allBtns[i].textContent || '');
          if(t.indexOf('copy') !== -1 && t.indexOf('line') !== -1){
            btn = allBtns[i];
            break;
          }
        }
      }
      if(!btn || btn.__pt_hooked) return;

      btn.__pt_hooked = true;
      btn.addEventListener('click', function(){
        setTimeout(function(){ ensureHistoryExistsFallback(); }, 350);
      }, true);

      REPORT_COPY_HOOKED = true;
    }catch(e){}
  }

  function readHistoryArray(win){
    try{
      var raw = win.localStorage.getItem(REPORT_KEYS.HISTORY);
      if(!raw) return [];
      var arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }

  function writeHistoryArray(win, arr){
    try{
      win.localStorage.setItem(REPORT_KEYS.HISTORY, JSON.stringify(arr));
      return true;
    }catch(e){ return false; }
  }

  function ensureHistoryExistsFallback(){
    var doc = getReportDoc();
    var win = getReportWin();
    if(!doc || !win || !win.localStorage) return;

    var previewEl = doc.getElementById('preview');
    var reportText = previewEl ? String(previewEl.textContent || '').trim() : '';
    if(!reportText) return;

    var now = Date.now();
    var arr = readHistoryArray(win);

    for(var i=0;i<Math.min(arr.length, 12);i++){
      var it = arr[i];
      if(!it) continue;
      var sameText = String(it.reportText || '') === reportText;
      var t = Number(it.createdAt || 0);
      if(sameText && (Math.abs(now - t) <= 10000 || t === 0)) return;
    }

    function gv(id){ var el = doc.getElementById(id); return el ? String(el.value || '').trim() : ''; }

    var entry = {
      id: String(Date.now()) + '_' + Math.random().toString(16).slice(2),
      createdAt: now,
      reportDateISO: gv('reportDate'),
      reportText: reportText,
      account: gv('account'),
      branchCode: gv('branchCode'),
      branchName: gv('branchName')
    };

    arr.unshift(entry);
    if(arr.length > 80) arr = arr.slice(0, 80);
    writeHistoryArray(win, arr);
  }

  function renderList(){
    renderHeader();

    if(META.total > 0 && META.remaining === 0){
      $('list').innerHTML =
        '<div class="center">' +
          '<div style="font-size:18px;font-weight:1000;color:#064e46">‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß üéâ</div>' +
          '<div style="margin-top:6px;font-weight:900">visited ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà</div>' +
          '<div style="margin-top:12px">' +
            '<button id="btnResetInside" class="btn-solid" style="min-height:44px;border-radius:14px;padding:10px 14px;" type="button">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà (‡∏•‡πâ‡∏≤‡∏á visited)</button>' +
          '</div>' +
        '</div>';
      $('btnResetInside').onclick = onResetAll;
      return;
    }

    var items = filteredPlaces();
    if(items.length === 0){
      $('list').innerHTML = '<div class="center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏•‡∏≠‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä)</div>';
      return;
    }

    var html = '';
    for(var i=0;i<items.length;i++){
      var p = items[i];
      var hasLL = hasLatLng_(p);
      var locText = hasLL ? (Number(p.lat).toFixed(6) + ', ' + Number(p.lng).toFixed(6)) : '<span class="warn">‚ö† ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î</span>';

      html +=
        '<div class="item" data-id="' + escapeHtml(p.id) + '">' +
          '<div class="name">[' + escapeHtml(p.id) + '] ' + escapeHtml(p.name) + '</div>' +
          '<div class="sub">' + locText + '</div>' +
          '<div class="actions">' +
            '<button class="a-btn a-nav" data-act="nav" type="button">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>' +
            '<button class="a-btn a-report" data-act="report" type="button">Report</button>' +
            '<button class="a-btn a-done" data-act="done" type="button"><b>‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</b></button>' +
          '</div>' +
        '</div>';
    }
    $('list').innerHTML = html;
  }

  function fitFrameNow(force){
    if(!map) return;
    var items = filteredPlaces().filter(hasLatLng_);
    var pts = [];
    if(currentLatLng) pts.push([currentLatLng.lat, currentLatLng.lng]);
    items.forEach(function(p){ pts.push([p.lat, p.lng]); });
    if(!pts.length) return;

    mapState.userInteracted = true;
    mapState.autoFitted = true;

    try{
      map.fitBounds(L.latLngBounds(pts).pad(0.15), { animate: !!force });
    }catch(e){}
  }

  function renderMap(){
    if(!map || !placesLayer) return;

    placesLayer.clearLayers();
    markerById.clear();

    var items = filteredPlaces().filter(hasLatLng_);

    items.forEach(function(p){
      var link = getOpenLink(p);

      var navHtml = link
        ? ('<a class="map-link" href="' + escapeHtml(link) + '" target="_blank" rel="noopener">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</a>')
        : ('<button class="map-link disabled" type="button" disabled>‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>');

      var reportHtml =
        '<button class="map-link map-report" type="button" data-id="' + escapeHtml(p.id) + '">Report</button>';

      var doneHtml =
        '<button class="map-link map-done" type="button" data-id="' + escapeHtml(p.id) + '">‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</button>';

      var popup =
        '<div style="font-weight:1000;color:#071915">[' + escapeHtml(p.id) + '] ' + escapeHtml(p.name) + '</div>' +
        '<div class="map-actions">' + navHtml + reportHtml + doneHtml + '</div>';

      var mk = L.marker([p.lat, p.lng]).addTo(placesLayer).bindPopup(popup);
      markerById.set(String(p.id), mk);
    });

    if(!mapState.userInteracted && !mapState.autoFitted){
      var pts = [];
      if(currentLatLng) pts.push([currentLatLng.lat, currentLatLng.lng]);
      items.forEach(function(p){ pts.push([p.lat, p.lng]); });
      if(pts.length){
        try{ map.fitBounds(L.latLngBounds(pts).pad(0.15)); }catch(e){}
        mapState.autoFitted = true;
      }
    }
  }

  function removeMarkerById_(id){
    id = String(id);
    var mk = markerById.get(id);
    if(mk){
      try{ mk.remove(); }catch(e){}
      markerById.delete(id);
    }
  }

  function cacheWrite_(payload, sheetName){
    try{
      localStorage.setItem(cacheKey_(sheetName), JSON.stringify({ ts: Date.now(), payload: payload }));
    }catch(e){}
  }

  function cacheRead_(sheetName){
    try{
      var raw = localStorage.getItem(cacheKey_(sheetName));
      if(!raw) return null;
      var obj = JSON.parse(raw);
      if(!obj || typeof obj !== 'object' || !obj.payload) return null;
      return obj;
    }catch(e){
      return null;
    }
  }

  function cacheRemove_(sheetName){
    try{ localStorage.removeItem(cacheKey_(sheetName)); }catch(e){}
  }

  function renderFromCacheIfAny_(sheetName){
    var cached = cacheRead_(sheetName);
    if(!cached || !cached.payload) return false;

    var res = cached.payload;
    if(!res || !res.ok) return false;

    META = {
      total: (res && res.total) ? res.total : 0,
      visited: (res && res.visited) ? res.visited : 0,
      remaining: (res && res.remaining) ? res.remaining : 0,
      rev: (res && res.rev) ? res.rev : null
    };

    PLACES = (res && res.places) ? res.places.filter(function(p){ return p && p.id && p.name; }) : [];
    renderList();
    if(map) renderMap();

    $('badgeText').textContent = (META.total ? ('‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ' + META.remaining + '/' + META.total) : '‡∏û‡∏£‡πâ‡∏≠‡∏°');
    return true;
  }

  async function loadPlaces(opts){
    opts = opts || {};
    await doLoadPlaces_(opts);
  }

  async function doLoadPlaces_(opts){
    opts = opts || {};
    var forceSpinner = !!opts.force;
    var sheetAtCall = CURRENT_SHEET || '';

    if(forceSpinner || (!PLACES || PLACES.length === 0)){
      var usedCache = renderFromCacheIfAny_(sheetAtCall);
      if(!usedCache) showLoading();
      else $('badgeText').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‚Ä¶';
    }else{
      $('badgeText').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‚Ä¶';
    }

    try{
      var res = await apiGetPlaces(sheetAtCall);
      if(sheetAtCall !== (CURRENT_SHEET || '')) return;

      if(!res || !res.ok){
        console.error('getPlaces failed:', res);
        $('badgeText').textContent = '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
        $('list').innerHTML =
          '<div class="center">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br><span class="warn">' +
          escapeHtml(res && res.message ? res.message : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏') +
          '</span></div>';
        return;
      }

      META = {
        total: (res && res.total) ? res.total : 0,
        visited: (res && res.visited) ? res.visited : 0,
        remaining: (res && res.remaining) ? res.remaining : 0,
        rev: (res && res.rev) ? res.rev : null
      };

      PLACES = (res && res.places) ? res.places.filter(function(p){ return p && p.id && p.name; }) : [];
      cacheWrite_(res, sheetAtCall);

      renderList();
      if(map) renderMap();
    }catch(err){
      if(sheetAtCall !== (CURRENT_SHEET || '')) return;
      console.error(err);
      $('badgeText').textContent = '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
      $('list').innerHTML =
        '<div class="center">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br><span class="warn">' + escapeHtml(err && err.message ? err.message : String(err)) + '</span></div>';
    }
  }

  function applyOptimisticVisited_(placeId){
    var id = String(placeId);
    if(PENDING.has(id)) return null;

    var idx = PLACES.findIndex(function(x){ return String(x.id) === id; });
    if(idx < 0) return null;

    var place = PLACES[idx];
    var snapshot = {
      id: id,
      place: place,
      idx: idx,
      sheet: (CURRENT_SHEET || ''),
      meta: { total: META.total, visited: META.visited, remaining: META.remaining, rev: META.rev }
    };

    PENDING.set(id, snapshot);

    PLACES.splice(idx, 1);

    META.visited = Math.min(META.total, (META.visited || 0) + 1);
    META.remaining = Math.max(0, META.total - META.visited);

    var el = $('list').querySelector('.item[data-id="' + CSS.escape(id) + '"]');
    if(el && el.parentNode) el.parentNode.removeChild(el);

    renderHeader();

    if(map) removeMarkerById_(id);

    if(META.total > 0 && META.remaining === 0){
      renderList();
      if(map) renderMap();
    }

    return snapshot;
  }

  function rollbackOptimisticVisited_(placeId){
    var id = String(placeId);
    var snap = PENDING.get(id);
    if(!snap) return;

    if(String(snap.sheet || '') !== String(CURRENT_SHEET || '')){
      PENDING.delete(id);
      return;
    }

    META = { total: snap.meta.total, visited: snap.meta.visited, remaining: snap.meta.remaining, rev: snap.meta.rev };
    var ins = Math.min(snap.idx, PLACES.length);
    PLACES.splice(ins, 0, snap.place);
    PENDING.delete(id);

    renderList();
    if(map) renderMap();
  }

  async function commitVisited_(placeId, sheetName){
    var id = String(placeId);
    var sh = String(sheetName || '');

    try{
      var res = await apiMarkVisited(id, sh);
      if(!res || !res.ok) throw new Error(res && res.message ? res.message : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

      PENDING.delete(id);
      showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');

      if(sh === String(CURRENT_SHEET || '')){
        var cached = cacheRead_(sh);
        if(cached && cached.payload && cached.payload.ok){
          cached.payload.total = META.total;
          cached.payload.visited = META.visited;
          cached.payload.remaining = META.remaining;
          cached.payload.places = PLACES;
          cacheWrite_(cached.payload, sh);
        }
      }
    }catch(err){
      console.error(err);
      rollbackOptimisticVisited_(id);
      showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß)');
    }
  }

  async function confirmAndMarkVisited(place){
    if(!place) return;

    var ok = await openModal({
      title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß',
      body:'[' + place.id + '] ' + place.name + '\n\n‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≠‡∏¢‡∏ã‡∏¥‡∏á‡∏Å‡πå‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö',
      okText:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
      cancelText:'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      danger:false
    });
    if(!ok) return;

    var snap = applyOptimisticVisited_(place.id);
    if(!snap){
      showToast('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö');
      return;
    }

    commitVisited_(place.id, snap.sheet);
  }

  $('list').addEventListener('click', function(ev){
    var btn = ev.target && ev.target.closest ? ev.target.closest('[data-act]') : null;
    if(!btn) return;

    var item = btn.closest('.item');
    if(!item) return;

    var id = item.getAttribute('data-id');
    var place = PLACES.find(function(x){ return String(x.id) === String(id); });
    if(!place){ showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); return; }

    var act = btn.getAttribute('data-act');

    if(act === 'nav'){ openMaps(place); return; }
    if(act === 'report'){ openReport(place); return; }
    if(act === 'done'){ confirmAndMarkVisited(place); return; }
  }, true);

  document.addEventListener('click', function(ev){
    var btn = ev.target && ev.target.closest ? ev.target.closest('.map-done') : null;
    if(!btn) return;

    ev.preventDefault();
    ev.stopPropagation();

    var id = btn.getAttribute('data-id');
    var place = PLACES.find(function(x){ return String(x.id) === String(id); });
    if(!place){ showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ'); return; }

    try{ if(map) map.closePopup(); }catch(e){}
    confirmAndMarkVisited(place);
  }, true);

  document.addEventListener('click', function(ev){
    var btn = ev.target && ev.target.closest ? ev.target.closest('.map-report') : null;
    if(!btn) return;

    ev.preventDefault();
    ev.stopPropagation();

    var id = btn.getAttribute('data-id');
    var place = PLACES.find(function(x){ return String(x.id) === String(id); });
    if(!place){ showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ'); return; }

    try{ if(map) map.closePopup(); }catch(e){}
    openReport(place);
  }, true);

  function requestGPS(){
    if(!navigator.geolocation){
      $('gpsPill').textContent = 'GPS: ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö';
      return;
    }
    $('gpsPill').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤ GPS‚Ä¶';
    navigator.geolocation.getCurrentPosition(function(pos){
      var lat = pos.coords.latitude;
      var lng = pos.coords.longitude;

      if(map) setCurrentLocation(lat, lng);
      else currentLatLng = {lat:lat, lng:lng};

      $('gpsPill').textContent = 'GPS: ‡∏û‡∏£‡πâ‡∏≠‡∏°';

      if($('sortMode').value === 'nearest'){
        renderList();
        if(map) renderMap();
      }else{
        if(map) renderMap();
      }
    }, function(err){
      console.warn(err);
      $('gpsPill').textContent = 'GPS: ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò/‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
    }, { enableHighAccuracy:true, timeout:10000, maximumAge:15000 });
  }

  async function onResetAll(){
    var ok = await openModal({
      title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
      body:'‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á visited ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?\n(‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)',
      okText:'‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
      cancelText:'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      danger:true
    });
    if(!ok) return;

    showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á‚Ä¶');

    var sheetAtCall = CURRENT_SHEET || '';

    try{
      var res = await apiResetVisitedAll(sheetAtCall);
      if(!res || !res.ok){
        showToast(res && res.message ? res.message : '‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        return;
      }

      PENDING.clear();
      cacheRemove_(sheetAtCall);

      showToast('‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
      $('q').value = '';
      setSortMode_('default', false);
      await loadPlaces({ force:true });
    }catch(err){
      console.error(err);
      showToast('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡∏•‡πâ‡∏≤‡∏á');
    }
  }

  function setPage(page){
    var isMap = (page === 'map');

    document.body.classList.toggle('map-open', isMap);
    updateFixedHeights();

    $('pageList').classList.toggle('active', !isMap);
    $('pageMap').classList.toggle('active', isMap);

    $('tabList').classList.toggle('active', !isMap);
    $('tabMap').classList.toggle('active', isMap);

    if(isMap){
      initMap();
      setTimeout(function(){
        try{ map.invalidateSize(); }catch(e){}
        renderMap();
      }, 60);
    }
  }

  function syncPageFromHash(){
    var h = (location.hash || '#list').toLowerCase();
    if(h === '#map') setPage('map');
    else setPage('list');
  }

  var rerenderAll = debounce(function(){
    renderList();
    if(map) renderMap();
  }, 90);

  $('q').addEventListener('input', rerenderAll);
  $('sortMode').addEventListener('change', function(){
    $('sortLabel').textContent = sortLabelFor_($('sortMode').value);
    renderSortList_();
    if($('sortMode').value === 'nearest' && !currentLatLng){
      showToast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏Å‡∏î GPS)');
    }
    rerenderAll();
  });

  $('btnRefresh').onclick = function(){
    loadPlaces({ force:true });
    requestGPS();
    showToast('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏•‡πâ‡∏ß');
  };

  $('btnResetAll').onclick = onResetAll;

  $('gpsPill').onclick = requestGPS;
  $('mePill').onclick = recenterToMe;
  $('fitPill').onclick = function(){ fitFrameNow(true); };

  $('tabList').onclick = function(){ location.hash = '#list'; };
  $('tabMap').onclick = function(){ location.hash = '#map'; };
  window.addEventListener('hashchange', syncPageFromHash);

  window.addEventListener('resize', function(){
    updateFixedHeights();
    if(document.body.classList.contains('map-open') && map){
      try{ map.invalidateSize(); }catch(e){}
    }
  });

  window.addEventListener('keydown', function(e){
    if(e.key === 'Escape'){
      if(sheetDropIsOpen_()){ closeSheetDrop_(); return; }
      if(sortDropIsOpen_()){ closeSortDrop_(); return; }
      if(document.body.classList.contains('set-open')){ closeSettings(); return; }
      if(document.body.classList.contains('rep-open')){ closeReport(); return; }
      if(sidebarIsOpen()){ closeSidebar(); return; }
    }
  });

  async function bootSheets_(){
    applyProjectTitle_();
    $('sheetList').innerHTML = '<div class="sheethint">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏µ‡∏ó‚Ä¶</div>';

    try{
      var res = await apiGetSheets();
      if(res && res.ok && Array.isArray(res.sheets) && res.sheets.length){
        SHEETS = res.sheets.slice();
        var def = res.defaultSheet ? String(res.defaultSheet) : '';
        var saved = '';
        try{ saved = localStorage.getItem(SELECTED_SHEET_KEY) || ''; }catch(e){ saved = ''; }

        var pick = '';
        if(saved && SHEETS.indexOf(saved) !== -1) pick = saved;
        else if(def && SHEETS.indexOf(def) !== -1) pick = def;
        else pick = SHEETS[0];

        setSelectedSheet_(pick, true);
        return;
      }
    }catch(e){}

    SHEETS = [];
    setSelectedSheet_(CURRENT_SHEET || '', false);
    $('sheetList').innerHTML = '<div class="sheethint">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
  }

  updateFixedHeights();
  renderSortList_();
  bootSheets_().then(function(){
    loadPlaces({ force:true });
  });
  requestGPS();
  syncPageFromHash();
</script>
</body>
</html>
